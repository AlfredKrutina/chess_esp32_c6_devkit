# Komplexní Mermaid Sequence Diagram - Hlavní Flow CZECHMATE v2.4
# Zkopírujte tento text do https://mermaid.live/ pro vizualizaci
#
# Tento diagram zachytává hlavní flow programu po inicializaci:
# - Všechny hlavní tasky a jejich smyčky
# - Komunikaci mezi tasky (fronty, mutexy, přímé volání)
# - Hlavní flow: fyzický tah, UART tah, button eventy
# - Timing a priority jednotlivých tasků
# - Detailní zobrazení mutexů a důvodů komunikace

sequenceDiagram
    participant WDT as Watchdog
    participant LT as ledTask_P7_33ms
    participant MT as matrixTask_P6_10ms
    participant BT as buttonTask_P5_5ms
    participant GT as gameTask_P4_100ms
    participant UT as uartTask_P3_1ms
    participant WT as webServerTask_P3
    participant GQ as gameCommandQueue
    participant BQ as buttonEventQueue
    participant URQ as uartResponseQueue
    participant LM as ledUnifiedMutex
    participant MM as matrixMutex
    participant UM as uartMutex
    participant GM as gameMutex
    participant HW as WS2812B_Hardware
    participant GPIO as GPIO_Hardware

    Note over WDT,GPIO: Hlavní flow programu po inicializaci - všechny tasky běží paralelně<br/>MUTEXY: Ochrana sdílených zdrojů (UART, LED stav, Matrix stav, Game stav)<br/>FRONTY: Asynchronní komunikace mezi tasky<br/>PŘÍMÉ VOLÁNÍ: Rychlá synchronní komunikace s mutex ochranou<br/>POZNÁMKY: Thread-safe funkce berou mutex UVNITŘ (led_set_pixel_safe, game_get_status_json, game_get_board_json, game_send_response_to_uart)<br/>game_process_* funkce běží v game_task a NEberou game_mutex (game_task má exkluzivní přístup k board[][])

    rect rgb(240, 240, 255)
        Note over LT,HW: LED TASK (Priorita 7, 33ms cyklus - 30 FPS)<br/>MUTEX: led_unified_mutex - Ochrana LED stavu (led_states[], led_pending_changes[])<br/>BATCH SYSTEM: Změny se sbírají a commitují atomicky
        
        loop Každých 33ms (led_task hlavní smyčka)
            LT->>WDT: esp_task_wdt_reset_safe()
            LT->>LT: led_process_commands()
            LT->>LT: led_update_animation()
            LT->>LT: led_update_endgame_wave()
            LT->>LT: led_process_button_blink_timers()
            LT->>LM: xSemaphoreTake(led_unified_mutex)
            activate LM
            Note over LT,LM: Batch commit - atomické zpracování všech změn
            LT->>LT: led_privileged_batch_commit()
            Note over LT: Batch update systém - commit všech pending změn
            LT->>HW: led_strip_refresh() - JEDEN refresh všech LED
            Note over HW: WS2812B protokol - 800kHz, timing-critical
            LT->>LM: xSemaphoreGive(led_unified_mutex)
            deactivate LM
            LT->>LT: vTaskDelayUntil(33ms)
        end
    end

    rect rgb(255, 240, 240)
        Note over MT,GPIO: MATRIX TASK (Priorita 6, 10ms cyklus + 20ms timer)<br/>MUTEX: matrix_mutex - Ochrana GPIO operací při skenování 8x8 matice
        
        loop Každých 10ms (matrix_task hlavní smyčka)
            MT->>WDT: esp_task_wdt_reset_safe()
            MT->>MT: matrix_process_commands()
            MT->>MT: vTaskDelayUntil(10ms)
        end
        
        Note over MT: Matrix scanning přes FreeRTOS timer callback (každých 20ms)
        MT->>MM: xSemaphoreTake(matrix_mutex)
        activate MM
        Note over MT,MM: Ochrana GPIO operací - prevence konfliktů při skenování
        MT->>GPIO: matrix_scan_all() - Skenování 8x8 Reed Switch matice
        loop Pro každý řádek (0-7)
            MT->>GPIO: Aktivace řádku (GPIO set LOW)
            MT->>GPIO: Čtení 8 sloupců (GPIO get level)
            MT->>MT: matrix_state[row*8+col] = (pin_level == 0) ? 1 : 0
            MT->>GPIO: Deaktivace řádku
        end
        MT->>MT: matrix_detect_moves() - Detekce změn (piece_lifted, piece_placed)
        MT->>GQ: xQueueSend(GAME_CMD_PICKUP) - Figurka zvednuta
        MT->>GQ: xQueueSend(GAME_CMD_DROP) - Figurka položena
        Note over MT,GQ: Asynchronní komunikace - game_task zpracuje ve svém cyklu (100ms)
        MT->>MM: xSemaphoreGive(matrix_mutex)
        deactivate MM
    end

    rect rgb(240, 255, 240)
        Note over BT,GPIO: BUTTON TASK (Priorita 5, 5ms cyklus)<br/>KOMUNIKACE: button_event_queue - Asynchronní zpracování button eventů
        
        loop Každých 5ms (button_task hlavní smyčka)
            BT->>WDT: esp_task_wdt_reset_safe()
            BT->>GPIO: button_scan_all() - GPIO scan všech tlačítek
            BT->>BT: button_process_events() - Detekce změn stavu
            alt Tlačítko stisknuto
                BT->>BQ: xQueueSend(BUTTON_EVENT_PRESS)
                activate BQ
                Note over BT,BQ: Asynchronní komunikace - game_task zpracuje ve svém cyklu
            end
            alt Tlačítko uvolněno
                BT->>BQ: xQueueSend(BUTTON_EVENT_RELEASE)
                alt Long press detekován
                    BT->>BQ: xQueueSend(BUTTON_EVENT_LONG_PRESS)
                end
            end
            BT->>BT: vTaskDelay(5ms)
        end
    end

    rect rgb(255, 255, 240)
        Note over GT,GQ: GAME TASK (Priorita 4, 100ms cyklus)<br/>MUTEX: game_mutex - Ochrana game stavu (pouze v funkcích volaných z jiných tasků)<br/>FRONTY: game_command_queue, button_event_queue, uart_response_queue<br/>POZNÁMKA: game_process_* funkce běží v game_task - NEberou game_mutex (game_task má exkluzivní přístup k board[][])
        
        loop Každých 100ms (game_task hlavní smyčka)
            GT->>WDT: esp_task_wdt_reset_safe()
            
            GT->>GQ: xQueueReceive(game_command_queue, 0)
            activate GQ
            alt Příkaz v frontě (max 15/cyklus)
                GT->>GT: game_process_commands()
                alt GAME_CMD_PICKUP
                    GT->>GT: game_process_pickup() - Uložení pozice
                    Note over GT: Funkce běží v game_task - NEbere game_mutex
                else GAME_CMD_DROP
                    GT->>GT: game_process_drop() - Detekce tahu
                    GT->>GT: game_process_chess_move()
                    Note over GT: Funkce běží v game_task - NEbere game_mutex
                else GAME_CMD_MAKE_MOVE
                    GT->>GT: game_process_chess_move() - UART/Web tah
                    Note over GT: Funkce běží v game_task - NEbere game_mutex<br/>game_send_response_to_uart() UVNITŘ bere game_mutex
                end
            end
            deactivate GQ
            
            GT->>BQ: xQueueReceive(button_event_queue, 0)
            activate BQ
            alt Button event v frontě
                GT->>GT: game_process_promotion_button() / game_reset_game()
                Note over GT: Funkce běží v game_task - NEbere game_mutex
            end
            deactivate BQ
            
            GT->>GT: game_update_timer_display() - Aktualizace času
            GT->>GT: Auto new game detection (počáteční pozice 2s)
            
            GT->>LT: led_set_pixel_safe() - PŘÍMÉ VOLÁNÍ LED (thread-safe, mutex UVNITŘ)
            Note over GT,LT: led_set_pixel_safe() interně bere led_unified_mutex<br/>Batch systém: změny se sbírají a commitují v LED tasku
            
            GT->>GT: vTaskDelayUntil(100ms)
        end
    end

    rect rgb(240, 255, 255)
        Note over UT,URQ: UART TASK (Priorita 3, 1ms cyklus)<br/>MUTEX: uart_mutex - Ochrana UART výstupu (prevence přepisování výstupu)<br/>FRONTY: uart_output_queue (vnitřní), uart_response_queue (odpovědi z game_task)
        
        loop Každých 1ms (uart_task hlavní smyčka)
            UT->>WDT: esp_task_wdt_reset_safe()
            
            UT->>UT: uart_process_output_queue() - Zpracování výstupní fronty
            loop Pro každou zprávu v uart_output_queue
                UT->>UM: xSemaphoreTake(uart_mutex)
                activate UM
                Note over UT,UM: Ochrana UART výstupu - prevence přepisování
                UT->>UT: uart_write_bytes() / printf() - Zápis do UART
                UT->>UM: xSemaphoreGive(uart_mutex)
                deactivate UM
            end
            
            UT->>UT: uart_read_bytes() - Čtení z UART
            UT->>UT: uart_process_input_char()
            alt Kompletní příkaz
                UT->>UT: uart_parse_command()
                alt Game command (MOVE, UP, DN, etc.)
                    UT->>GQ: xQueueSend(GAME_CMD_MAKE_MOVE / GAME_CMD_*)
                    Note over UT,GQ: Asynchronní komunikace - game_task zpracuje ve svém cyklu
                end
            end
            
            UT->>UT: vTaskDelay(1ms)
        end
    end

    rect rgb(255, 240, 255)
        Note over WT,GM: WEB SERVER TASK (Priorita 3)<br/>KOMUNIKACE: Přímé volání s game_mutex ochranou<br/>MUTEX: game_mutex - Ochrana při čtení game stavu
        
        loop HTTP request handling
            WT->>WT: httpd_req_recv() - HTTP request
            alt POST /api/move
                WT->>WT: http_post_move_handler() - Parsování JSON
                WT->>GQ: xQueueSend(GAME_CMD_MAKE_MOVE)
                Note over WT,GQ: Asynchronní komunikace - game_task zpracuje ve svém cyklu
                WT->>WT: HTTP 200 OK - {"success":true}
            else GET /api/status
                WT->>GT: game_get_status_json() - Přímé volání (thread-safe, mutex UVNITŘ)
                activate GT
                GT->>GM: xSemaphoreTake(game_mutex)
                activate GM
                Note over WT,GM: Přímé volání - rychlá synchronní komunikace<br/>game_get_status_json() bere game_mutex UVNITŘ funkce
                GT->>GT: Čtení game stavu (current_player, current_game_state, etc.)
                GT->>GM: xSemaphoreGive(game_mutex)
                deactivate GM
                GT-->>WT: JSON status
                deactivate GT
                WT->>WT: HTTP 200 OK - JSON response
            else GET /api/board
                WT->>GT: game_get_board_json() - Přímé volání (thread-safe, mutex UVNITŘ)
                activate GT
                GT->>GM: xSemaphoreTake(game_mutex)
                activate GM
                Note over WT,GM: Přímé volání - rychlá synchronní komunikace<br/>game_get_board_json() bere game_mutex UVNITŘ funkce
                GT->>GT: Čtení board[8][8]
                GT->>GM: xSemaphoreGive(game_mutex)
                deactivate GM
                GT-->>WT: JSON board[8][8]
                deactivate GT
                WT->>WT: HTTP 200 OK - JSON response
            end
        end
    end

    Note over GT,LT: Příklad: Fyzický tah flow
    MT->>MM: xSemaphoreTake(matrix_mutex)
    activate MM
    MT->>GPIO: matrix_scan_all() - Detekce zvednutí figurky (e2)
    MT->>MM: xSemaphoreGive(matrix_mutex)
    deactivate MM
    MT->>GQ: xQueueSend(GAME_CMD_PICKUP, e2)
    GT->>GQ: xQueueReceive()
    GT->>GT: game_process_pickup() - Uložení e2
    Note over GT: Funkce běží v game_task - NEbere game_mutex
    
    MT->>MM: xSemaphoreTake(matrix_mutex)
    activate MM
    MT->>GPIO: matrix_scan_all() - Detekce položení figurky (e4)
    MT->>MM: xSemaphoreGive(matrix_mutex)
    deactivate MM
    MT->>GQ: xQueueSend(GAME_CMD_DROP, e4)
    GT->>GQ: xQueueReceive()
    GT->>GT: game_process_drop() - Detekce e2→e4
    GT->>GT: game_is_valid_move() - Validace tahu
    alt Tah validní
        GT->>GT: game_execute_move() - Provedení tahu
        GT->>GT: game_check_end_game_conditions()
        GT->>LT: led_set_pixel_safe() - LED animace tahu (thread-safe, mutex UVNITŘ)
        LT->>HW: led_strip_refresh() - WS2812B refresh
    else Tah nevalidní
        GT->>GT: Error recovery (červené LED)
    end

    Note over GT,UT: Příklad: UART tah flow (s odpověďmi)
    UT->>UT: uart_parse_command("move e2 e4")
    UT->>GQ: xQueueSend(GAME_CMD_MAKE_MOVE, e2→e4)
    GT->>GQ: xQueueReceive()
    GT->>GT: game_process_chess_move()
    Note over GT: Funkce běží v game_task - NEbere game_mutex
    GT->>GT: game_is_valid_move()
    alt Tah validní
        GT->>GT: game_execute_move()
        GT->>GT: game_check_end_game_conditions()
        GT->>GT: game_send_response_to_uart() - Odpověď (thread-safe, mutex UVNITŘ)
        Note over GT,URQ: game_send_response_to_uart() bere game_mutex UVNITŘ a posílá do uart_response_queue
        GT->>URQ: xQueueSend(response_queue, success)
        GT->>LT: led_set_pixel_safe() - LED animace (thread-safe, mutex UVNITŘ)
        LT->>HW: led_strip_refresh()
    else Tah nevalidní
        GT->>GT: game_send_response_to_uart() - Odpověď (thread-safe, mutex UVNITŘ)
        GT->>URQ: xQueueSend(response_queue, error)
    end
    UT->>UM: xSemaphoreTake(uart_mutex)
    activate UM
    UT->>UT: uart_write_bytes() - Zápis odpovědi do UART
    UT->>UM: xSemaphoreGive(uart_mutex)
    deactivate UM

    Note over BT,GT: Příklad: Button event flow (promoce)
    BT->>GPIO: GPIO scan - Promotion button stisknuto
    BT->>BQ: xQueueSend(BUTTON_EVENT_PRESS, button_id)
    GT->>BQ: xQueueReceive()
    GT->>GT: game_process_promotion_button()
    GT->>GT: game_execute_promotion()
    Note over GT: Funkce běží v game_task - NEbere game_mutex
    GT->>LT: led_set_pixel_safe() - LED feedback (thread-safe, mutex UVNITŘ)
    LT->>HW: led_strip_refresh()
