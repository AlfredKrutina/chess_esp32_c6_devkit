# Mermaid Sequence Diagramy pro CZECHMATE v2.4
# VloÅ¾te obsah tohoto souboru do https://mermaid.live/ pro vizualizaci

# =============================================================================
# 1. FyzickÃ½ tah (Matrix â†’ Game â†’ LED)
# =============================================================================

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask
    participant A as animationTask
    participant AQ as animationCommandQueue

    Note over M: SkenovÃ¡nÃ­ 8x8 matice pÅ™es FreeRTOS timer<br/>Detekce Reed SwitchÅ¯ pomocÃ­ time-multiplexingu
    
    M->>M: matrix_scan_all() - Sken vÅ¡ech Å™Ã¡dkÅ¯ s mutex ochranou, Debounce (3x sken)
    M->>M: matrix_detect_moves() - Detekce zmÄ›n, piece_lifted detected (e2)
    M->>GQ: xQueueSend(GAME_CMD_PICKUP) from: e2
    activate GQ
    G->>GQ: xQueueReceive() - zpracovÃ¡nÃ­ pÅ™Ã­kazÅ¯ z FIFO fronty
    deactivate GQ
    
    Note over G: game_process_commands() - game_process_pickup_command() - Validace figurky
    G->>G: Kontrola, zda je tah moÅ¾nÃ½ - game_get_available_moves()
    G->>L: led_set_pixel_safe() - ZvÃ½raznÄ›nÃ­ zdroje (Å¾lutÃ¡) - PÅ˜ÃMÃ‰ VOLÃNÃ s led_mutex
    G->>L: led_set_pixel_safe() - ZobrazenÃ­ validnÃ­ch tahÅ¯ (zelenÃ¡)
    
    Note over L: LED batch update systÃ©m - led_commit_pending_changes()<br/>WS2812B refresh (33ms cyklus)
    
    M->>M: matrix_scan_all() - DalÅ¡Ã­ sken (time-multiplexing: 20ms matrix, 5ms buttons)
    M->>M: matrix_detect_moves() - piece_placed detected (e4)
    M->>GQ: xQueueSend(GAME_CMD_DROP) from: e2, to: e4
    activate GQ
    G->>GQ: xQueueReceive() - zpracovÃ¡nÃ­ DROP pÅ™Ã­kazu
    deactivate GQ
    
    Note over G: game_process_drop_command() - Validace tahu - game_is_valid_move()<br/>Kontrola Å¡achovÃ½ch pravidel
    
    alt Tah je validnÃ­
        G->>G: game_execute_move() - Aktualizace board[][] - ZmÄ›na hrÃ¡Äe - Kontrola Å¡ach/mat
        G->>L: led_execute_command_new() - LED_CMD_ANIM_MOVE_PATH - PÅ˜ÃMÃ‰ VOLÃNÃ
        Note over L: Move path animace - Å¾lutÃ¡ â†’ zelenÃ¡ pÅ™echod
        
        opt Endgame detekovÃ¡n (Å¡achmat/pat/remÃ­za)
            G->>AQ: xQueueSend() - animation command pro endgame animaci
            activate AQ
            A->>AQ: xQueueReceive()
            deactivate AQ
            A->>L: led_set_pixel_safe() - Endgame wave animace
        end
        
        G->>L: led_clear_board_only() - ZhasnutÃ­ zvÃ½raznÄ›nÃ­
    else Tah nenÃ­ validnÃ­
        G->>L: led_set_pixel_safe() - ÄŒervenÃ¡ (chyba) - Zdroj + cÃ­l - Error handling flow
        Note over G: Error recovery state aktivnÃ­ - ÄekÃ¡nÃ­ na korekci tahu
        G->>L: led_clear_board_only() - Po nÃ¡vratu figurky zhasnutÃ­
    end
    
    Note over L: KontinuÃ¡lnÃ­ LED update - 33ms cyklus - Batch commit zmÄ›n

# =============================================================================
# 2. Tah pÅ™es UART
# =============================================================================

sequenceDiagram
    participant U as uartTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask
    participant URQ as uartResponseQueue

    Note over U: uart_task_legacy_loop() - ÄŒtenÃ­ znakÅ¯ z UART - ParsovÃ¡nÃ­ pÅ™Ã­kazÅ¯
    U->>U: uart_process_input() - "move e2e4"
    U->>U: uart_parse_command() - ParsovÃ¡nÃ­ "move" pÅ™Ã­kazu
    U->>U: uart_cmd_move() - Validace notace - PÅ™evod na chess_move_command_t
    U->>GQ: xQueueSend(GAME_CMD_MAKE_MOVE) from: e2, to: e4 - response_queue: uart_response_queue
    activate GQ
    G->>GQ: xQueueReceive() - zpracovÃ¡nÃ­ pÅ™Ã­kazÅ¯
    deactivate GQ
    
    Note over G: game_process_commands() - game_process_chess_move()
    G->>G: convert_notation_to_coords() - PÅ™evod e2â†’[1,4], e4â†’[3,4]
    G->>G: game_is_valid_move() - Validace Å¡achovÃ½ch pravidel
    
    alt Tah je validnÃ­
        G->>L: led_set_pixel_safe() - ZvÃ½raznÄ›nÃ­ zdroje (Å¾lutÃ¡)
        G->>L: game_get_available_moves() - ZobrazenÃ­ validnÃ­ch tahÅ¯
        G->>G: game_execute_move() - Aktualizace board[][] - ZmÄ›na hrÃ¡Äe
        G->>L: led_execute_command_new() - LED_CMD_ANIM_MOVE_PATH
        Note over L: Move path animace - Å¾lutÃ¡ â†’ zelenÃ¡
        G->>G: game_check_end_game_conditions() - Å ach? Mat? RemÃ­za?
        G->>URQ: xQueueSend(response) - "âœ… MOVE EXECUTED"
        activate URQ
        U->>URQ: xQueueReceive()
        deactivate URQ
        U->>U: uart_send_formatted() - VÃ½pis vÃ½sledku - pomocÃ­ uart_mutex
    else Tah nenÃ­ validnÃ­
        G->>URQ: xQueueSend(error_response) - "âŒ Invalid move"
        activate URQ
        U->>URQ: xQueueReceive()
        deactivate URQ
        U->>U: uart_send_error() - VÃ½pis chyby
    end

# =============================================================================
# 3. Button Events a Promoce
# =============================================================================

sequenceDiagram
    participant BT as buttonTask
    participant BQ as buttonEventQueue
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over BT: Hardware GPIO scan - Button press detection - 5ms cyklus
    BT->>BT: button_process_events() - GPIO scan - Debounce kontrola (50ms)
    BT->>BT: button_handle_press() - button_id: QUEEN (0)
    BT->>BQ: xQueueSend(BUTTON_EVENT_PRESS) - button_id: 0 (QUEEN)
    activate BQ
    G->>BQ: xQueueReceive(button_event_queue)
    deactivate BQ
    
    Note over G: game_process_commands() - ZpracovÃ¡nÃ­ button eventÅ¯
    
    opt Promotion button
        G->>G: game_process_promotion_button(0) - choice = PROMOTION_QUEEN
        Note over G: game_process_promotion_command() - Promoce pÄ›Å¡ce - Aktualizace board[][]
        G->>L: led_set_pixel_safe() - PromoÄnÃ­ animace - PÅ˜ÃMÃ‰ VOLÃNÃ
        G->>G: game_check_end_game_conditions()
    end
    
    opt Reset button
        G->>G: game_reset_game() - Reset na poÄÃ¡teÄnÃ­ pozici
        G->>L: led_show_chess_board() - ZobrazenÃ­ poÄÃ¡teÄnÃ­ pozice
    end
    
    Note over L: Button LED feedback - ZelenÃ¡/ModrÃ¡/ÄŒervenÃ¡ - podle dostupnosti

# =============================================================================
# 4. Startup sekvence
# =============================================================================

sequenceDiagram
    participant HW as ESP32_Hardware
    participant M as app_main
    participant NVS as NVS_Flash
    participant Q as Queues
    participant MTX as Mutexes
    participant T as TaskCreation
    participant WDT as Watchdog
    participant LT as ledTask
    participant MT as matrixTask
    participant GT as gameTask
    participant UT as uartTask

    HW->>M: Boot â†’ app_main()
    Note over M: ESP32-C6 Chess v2.4 - Inicializace systÃ©mu
    M->>WDT: esp_task_wdt_reconfigure() - 10s timeout (init)
    M->>WDT: esp_task_wdt_add(NULL) - Registrace main task
    M->>NVS: nvs_flash_init() - Non-Volatile Storage
    NVS-->>M: ESP_OK
    
    M->>Q: xQueueCreate(game_command_queue, 50)
    M->>Q: xQueueCreate(button_event_queue, 5)
    M->>Q: xQueueCreate(animation_command_queue, 5)
    Q-->>M: Queue handles
    
    M->>MTX: xSemaphoreCreateMutex() - uart_mutex
    M->>MTX: xSemaphoreCreateMutex() - led_mutex, matrix_mutex
    MTX-->>M: Mutex handles
    
    Note over T: VytvÃ¡Å™enÃ­ taskÅ¯ - v poÅ™adÃ­ priority
    M->>T: xTaskCreate(led_task, P7, 16KB)
    T->>LT: led_task_start()
    LT->>LT: led_hardware_init() - WS2812B init
    LT->>WDT: esp_task_wdt_add(NULL)
    
    M->>T: xTaskCreate(matrix_task, P6, 8KB)
    T->>MT: matrix_task_start()
    MT->>MT: matrix_reset() - GPIO init
    MT->>WDT: esp_task_wdt_add(NULL)
    
    M->>T: xTaskCreate(button_task, P5, 3KB)
    M->>T: xTaskCreate(game_task, P4, 10KB)
    M->>T: xTaskCreate(uart_task, P3, 10KB) - SUSPENDED
    M->>T: xTaskCreate(animation_task, P3, 2KB)
    M->>T: xTaskCreate(web_server_task, P3, 20KB)
    M->>T: xTaskCreate(test_task, P1, 4KB)
    
    Note over M: vTaskDelay(1000ms) - ÄŒekÃ¡nÃ­ na inicializaci
    M->>LT: show_boot_animation_and_board() - Boot animace
    M->>GT: initialize_chess_game() - PoÄÃ¡teÄnÃ­ pozice
    M->>UT: vTaskResume(uart_task_handle) - Resume po boot animaci
    M->>WDT: esp_task_wdt_reconfigure() - 8s timeout (normal)
    
    Note over M: FreeRTOS Scheduler - pÅ™evezme Å™Ã­zenÃ­<br/>app_main() NIKDY NEKONÄŒÃ

# =============================================================================
# 5. Promotion flow (kompletnÃ­)
# =============================================================================

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask
    participant BQ as buttonEventQueue
    participant BT as buttonTask
    participant U as uartTask

    Note over M: PÄ›Å¡ec dosÃ¡hl poslednÃ­ Å™ady
    M->>GQ: GAME_CMD_DROP - from: e7, to: e8
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    
    Note over G: game_process_drop_command() - game_execute_move()
    G->>G: game_check_promotion_needed() - board[7][col] == PAWN
    
    alt PÄ›Å¡ec na poslednÃ­ Å™adÄ›
        G->>G: promotion_state.pending = true - promotion_state.square = e8 - promotion_state.player = WHITE
        G->>L: led_set_pixel_safe() - LED 64-67: ZELENÃ (White) - LED 68-71: MODRÃ (Black)
        G->>U: printf() - "ğŸ‘‘ PAWN PROMOTION AVAILABLE!" - Menu s moÅ¾nostmi
        Note over G: Matrix events PAUSED - ÄŒekÃ¡nÃ­ na vÃ½bÄ›r figury
        
        par FyzickÃ© tlaÄÃ­tko
            BT->>BQ: BUTTON_EVENT_PRESS - button_id: 0 (QUEEN)
            activate BQ
            G->>BQ: xQueueReceive(button_event_queue)
            deactivate BQ
            G->>G: game_process_promotion_button(0) - choice = PROMOTION_QUEEN
        and UART pÅ™Ã­kaz
            U->>GQ: GAME_CMD_PROMOTION - square: e8, piece: QUEEN
            activate GQ
            G->>GQ: xQueueReceive()
            deactivate GQ
            G->>G: game_process_promotion_command() - choice = PROMOTION_QUEEN
        end
        
        G->>G: game_execute_promotion(choice) - board[7][4] = PIECE_WHITE_QUEEN
        G->>L: led_set_pixel_safe() - PromoÄnÃ­ animace - PestrÃ© efekty
        G->>G: promotion_state.pending = false - Matrix events RESUMED
        G->>G: game_check_end_game_conditions() - Kontrola Å¡ach/mat
        G->>G: current_player = BLACK - ZmÄ›na hrÃ¡Äe
    end

# =============================================================================
# 6. Castling flow (dvoufÃ¡zovÃ½)
# =============================================================================

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over M: HrÃ¡Ä zvedÃ¡ krÃ¡le z e1
    M->>GQ: GAME_CMD_PICKUP - from: e1
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    G->>G: game_process_pickup_command() - ZvÃ½raznÄ›nÃ­ e1
    
    Note over M: HrÃ¡Ä poklÃ¡dÃ¡ krÃ¡le na g1 (kingside)
    M->>GQ: GAME_CMD_DROP - from: e1, to: g1
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    
    Note over G: game_process_drop_command() - Detekce roÅ¡Ã¡dy: king move 2 squares
    G->>G: game_is_valid_move() - Kontrola roÅ¡Ã¡dovÃ½ch podmÃ­nek:<br/>KrÃ¡l a vÄ›Å¾ se nehÃ½baly, Pole mezi nimi prÃ¡zdnÃ¡,<br/>KrÃ¡l nenÃ­ v Å¡achu, Pole nejsou napadenÃ¡
    
    alt RoÅ¡Ã¡da validnÃ­
        G->>G: game_execute_move() - board[0][4] = EMPTY - board[0][6] = KING
        G->>G: castling_state.in_progress = true - castling_state.rook_from = h1 - castling_state.rook_to = f1
        G->>L: led_set_pixel_safe() - ZvÃ½raznÄ›nÃ­ vÄ›Å¾e h1 (Å¾lutÃ¡) - ZvÃ½raznÄ›nÃ­ f1 (zelenÃ¡)
        G->>L: game_start_repeating_rook_animation() - OpakujÃ­cÃ­ se animace pohybu vÄ›Å¾e
        Note over G: ÄŒekÃ¡nÃ­ na pohyb vÄ›Å¾e - Matrix events stÃ¡le aktivnÃ­
        
        M->>GQ: GAME_CMD_PICKUP - from: h1
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        M->>GQ: GAME_CMD_DROP - from: h1, to: f1
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        
        G->>G: game_check_castling_completion() - Kontrola sprÃ¡vnÃ©ho tahu vÄ›Å¾e
        
        alt VÄ›Å¾ na sprÃ¡vnÃ© pozici
            G->>G: board[0][7] = EMPTY - board[0][5] = ROOK
            G->>G: white_king_moved = true - white_rook_h_moved = true
            G->>L: show_castling_completion_animation() - ZlatÃ¡ animace
            G->>G: castling_state.in_progress = false - current_player = BLACK
            G->>G: game_check_end_game_conditions()
        else VÄ›Å¾ na Å¡patnÃ© pozici
            G->>L: led_set_pixel_safe() - ÄŒervenÃ¡ (chyba)
            Note over G: ÄŒekÃ¡ na sprÃ¡vnÃ½ tah vÄ›Å¾e
        end
    end

# =============================================================================
# 7. Web server flow
# =============================================================================

sequenceDiagram
    participant C as WebClient
    participant WS as webServerTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over C: UÅ¾ivatel klikne na Å¡achovnici - e2 â†’ e4
    C->>WS: POST /api/move - {"from":"e2","to":"e4"}
    WS->>WS: http_post_move_handler() - ParsovÃ¡nÃ­ JSON
    WS->>WS: web_is_locked() - Kontrola zÃ¡mku
    
    alt Web nenÃ­ zamÄenÃ½
        WS->>WS: chess_move_command_t cmd - GAME_CMD_MAKE_MOVE - from: e2, to: e4
        WS->>GQ: xQueueSend(cmd, 100ms)
        activate GQ
        Note over WS: Non-blocking - OkamÅ¾itÃ½ return
        WS->>C: HTTP 200 OK - {"success":true,"message":"Move queued"}
        G->>GQ: xQueueReceive()
        deactivate GQ
        
        Note over G: game_process_commands() - game_process_chess_move()
        G->>G: game_is_valid_move() - Validace tahu
        
        alt Tah validnÃ­
            G->>G: game_execute_move() - Aktualizace board[][]
            G->>L: led_execute_command_new() - Move path animace
            G->>G: game_check_end_game_conditions()
            G->>G: current_player = BLACK
        end
    else Web zamÄenÃ½
        WS->>C: HTTP 403 Forbidden - {"success":false,"message":"Web locked"}
    end
    
    Note over C: Polling kaÅ¾dÃ© 500ms - GET /api/status - GET /api/board
    C->>WS: GET /api/status
    WS->>G: game_get_status_json() - PÅ™Ã­mÃ© volÃ¡nÃ­ API
    G-->>WS: JSON status
    WS->>C: HTTP 200 OK - {"game_state":"active",...}
    
    C->>WS: GET /api/board
    WS->>G: game_get_board_json() - PÅ™Ã­mÃ© volÃ¡nÃ­ API
    G-->>WS: JSON board[8][8]
    WS->>C: HTTP 200 OK - {"board":[[...],...]}

# =============================================================================
# 8. Endgame detection flow
# =============================================================================

sequenceDiagram
    participant G as gameTask
    participant L as ledTask
    participant AQ as animationCommandQueue
    participant A as animationTask
    participant U as uartTask
    participant WS as webServerTask

    Note over G: Po kaÅ¾dÃ©m tahu: game_check_end_game_conditions()
    G->>G: game_is_king_in_check(current_player) - Kontrola Å¡achu
    G->>G: game_has_legal_moves(current_player) - Kontrola validnÃ­ch tahÅ¯
    
    alt Å ach + Å¾Ã¡dnÃ© tahy (Checkmate)
        G->>G: current_result_type = RESULT_BLACK_WINS / RESULT_WHITE_WINS
        G->>G: game_update_endgame_statistics() - Aktualizace statistik
        G->>G: timer_pause() - ZastavenÃ­ hodin
        G->>L: start_endgame_animation() - ENDGAME_ANIM_VICTORY_WAVE - VlnovÃ½ efekt
        G->>U: game_print_endgame_report_uart() - KompletnÃ­ report
        G->>WS: game_get_status_json() - JSON s game_state="finished"
        Note over G: RozliÅ¡enÃ­ typu Å¡achmatu: En passant, Castling, Promotion, Discovered check
    else NenÃ­ Å¡ach + Å¾Ã¡dnÃ© tahy (Stalemate)
        G->>G: current_result_type = RESULT_DRAW_STALEMATE
        G->>G: game_update_endgame_statistics()
        G->>G: timer_pause()
        G->>L: start_endgame_animation() - ENDGAME_ANIM_DRAW
        G->>U: game_print_endgame_report_uart()
    else 50-Move Rule
        G->>G: moves_without_capture >= 100 - Kontrola poÄÃ­tadla
        G->>G: current_result_type = RESULT_DRAW_50_MOVE
        G->>G: game_update_endgame_statistics()
        G->>G: timer_pause()
        G->>L: start_endgame_animation()
        G->>U: game_print_endgame_report_uart()
    else Threefold Repetition
        G->>G: game_is_position_repeated() - Kontrola historie pozic
        G->>G: current_result_type = RESULT_DRAW_REPETITION
        G->>G: game_update_endgame_statistics()
        G->>G: timer_pause()
        G->>L: start_endgame_animation()
        G->>U: game_print_endgame_report_uart()
    else Insufficient Material
        G->>G: game_is_insufficient_material() - King vs King, King+Bishop, etc.
        G->>G: current_result_type = RESULT_DRAW_INSUFFICIENT
        G->>G: game_update_endgame_statistics()
        G->>G: timer_pause()
        G->>L: start_endgame_animation()
        G->>U: game_print_endgame_report_uart()
    end
    
    Note over G: current_game_state = GAME_STATE_FINISHED - Hra ukonÄena

# =============================================================================
# 9. Timer timeout flow
# =============================================================================

sequenceDiagram
    participant TS as timerSystem
    participant G as gameTask
    participant GQ as gameCommandQueue
    participant L as ledTask
    participant U as uartTask

    Note over TS: Timer bÄ›Å¾Ã­ pro aktuÃ¡lnÃ­ho hrÃ¡Äe
    TS->>TS: timer_check_timeout() - Kontrola kaÅ¾dou sekundu
    
    alt ÄŒas vyprÅ¡el
        TS->>GQ: xQueueSend(GAME_CMD_TIMER_TIMEOUT) - Timeout event
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        
        Note over G: game_process_timer_command() - game_handle_time_expiration()
        G->>TS: timer_get_state() - ZÃ­skÃ¡nÃ­ stavu timeru
        TS-->>G: timer_data.is_white_turn
        G->>G: winner = opposite_player - UrÄenÃ­ vÃ­tÄ›ze
        G->>G: current_game_state = GAME_STATE_FINISHED<br/>current_result_type = RESULT_WHITE_WINS / RESULT_BLACK_WINS<br/>current_endgame_reason = ENDGAME_REASON_TIMEOUT
        G->>G: game_update_endgame_statistics() - Aktualizace statistik
        G->>TS: timer_pause() - ZastavenÃ­ timeru
        G->>L: start_endgame_animation() - ENDGAME_ANIM_VICTORY_WAVE - VlnovÃ½ efekt pro vÃ­tÄ›ze
        G->>U: game_print_endgame_report_uart() - "ğŸ† White wins by timeout!"
        Note over G: endgame_report_requested = true - Pro asynchronnÃ­ vÃ½pis
    end
    
    Note over G: game_update_timer_display() - VolÃ¡no kaÅ¾dÃ½ cyklus - game_task main loop

# =============================================================================
# 10. En passant flow (brÃ¡nÃ­ mimochodem)
# =============================================================================

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over M: PrvnÃ­ tah: BÃ­lÃ½ pÄ›Å¡ec se pohybuje o 2 pole (e2â†’e4)
    M->>GQ: GAME_CMD_DROP - from: e2, to: e4
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    
    Note over G: game_execute_move_enhanced() - Detekce double move (2 pole)
    G->>G: PÄ›Å¡ec se pohybuje o 2 pole â†’ en_passant_available = true<br/>en_passant_target_row = 3 (mezi e2 a e4), en_passant_target_col = 4<br/>en_passant_victim_row = 3, en_passant_victim_col = 4
    
    Note over M: DruhÃ½ tah: ÄŒernÃ½ pÄ›Å¡ec mÅ¯Å¾e provÃ©st en passant (d5â†’e4 pÅ™es e5)
    M->>GQ: GAME_CMD_PICKUP - from: d5
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    G->>L: led_set_pixel_safe() - ZvÃ½raznÄ›nÃ­ d5 (Å¾lutÃ¡)
    G->>L: led_set_pixel_safe() - ZobrazenÃ­ validnÃ­ch tahÅ¯ vÄetnÄ› e4 (en passant)
    
    M->>GQ: GAME_CMD_DROP - from: d5, to: e4
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    
    Note over G: game_process_drop_command() - game_is_valid_move() - Detekce en passant
    G->>G: game_is_en_passant_possible() - Kontrola:<br/>poslednÃ­ tah byl pÄ›Å¡ec o 2 pole,<br/>ÃºtoÄÃ­cÃ­ pÄ›Å¡ec vedle,<br/>cÃ­lovÃ© pole = en_passant_target
    
    alt En passant validnÃ­
        G->>G: extended_move.move_type = MOVE_TYPE_EN_PASSANT
        G->>G: game_execute_move_enhanced() - MOVE_TYPE_EN_PASSANT case
        G->>G: board[e4][4] = PIECE_BLACK_PAWN - PÄ›Å¡ec se pÅ™esune na e4<br/>board[e5][4] = PIECE_EMPTY - OdstranÄ›nÃ­ bÃ­lÃ©ho pÄ›Å¡ce z e4 (en passant victim)<br/>last_move_type = LAST_MOVE_EN_PASSANT
        G->>L: led_execute_command_new() - LED_CMD_ANIM_MOVE_PATH - Animace en passant tahu
        Note over L: ZobrazenÃ­ pohybu d5â†’e4 a odstranÄ›nÃ­ pÄ›Å¡ce z e4
        G->>G: en_passant_available = false - En passant moÅ¾nÃ½ pouze jeden tah
        G->>G: game_check_end_game_conditions()
    end

# =============================================================================
# 11. Error handling flow (zpracovÃ¡nÃ­ neplatnÃ½ch tahÅ¯)
# =============================================================================

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask
    participant U as uartTask

    Note over M: HrÃ¡Ä provÃ¡dÃ­ neplatnÃ½ tah (napÅ™. pÄ›Å¡ec Å¡ikmo bez branÃ­)
    M->>GQ: GAME_CMD_PICKUP - from: e2
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    G->>L: led_set_pixel_safe() - ZvÃ½raznÄ›nÃ­ e2 (Å¾lutÃ¡) - ZobrazenÃ­ validnÃ­ch tahÅ¯ (zelenÃ¡)
    
    M->>GQ: GAME_CMD_DROP - from: e2, to: f3 (neplatnÃ½ tah)
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    
    Note over G: game_process_drop_command() - game_is_valid_move() - Validace tahu
    G->>G: game_is_valid_move() - Kontrola Å¡achovÃ½ch pravidel â†’ false (neplatnÃ½ tah)
    
    alt NeplatnÃ½ tah detekovÃ¡n
        G->>G: error_recovery_state.waiting_for_move_correction = true<br/>error_recovery_state.invalid_row = 5 (f3)<br/>error_recovery_state.invalid_col = 5 (f3)<br/>error_recovery_state.original_valid_row = 1 (e2)<br/>error_recovery_state.original_valid_col = 4 (e2)
        G->>L: game_show_invalid_move_error_with_blink() - ÄŒervenÃ© blikÃ¡nÃ­ na f3
        Note over L: blink_state.active = true - 10x bliknutÃ­, interval 300ms<br/>ÄŒervenÃ¡ barva pro upoutÃ¡nÃ­ pozornosti
        G->>G: board[5][5] = lifted_piece - Figurka je na neplatnÃ© pozici (fyzickÃ¡ realita)<br/>current_game_state = GAME_STATE_WAITING_FOR_RETURN
        G->>U: game_send_response_to_uart() - "âŒ Invalid move to f3 - return to ORIGINAL e2 or find valid move"
        Note over G: Matrix events stÃ¡le aktivnÃ­ - ÄekÃ¡nÃ­ na korekci tahu
        
        M->>GQ: GAME_CMD_PICKUP - from: f3 (hrÃ¡Ä zvedÃ¡ figurku z neplatnÃ© pozice)
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        Note over G: game_process_pickup_command() - Detekce error recovery state
        G->>G: game_stop_error_blink() - ZastavenÃ­ blikÃ¡nÃ­
        G->>L: led_clear_board_only() - VymazÃ¡nÃ­ ÄervenÃ©ho zvÃ½raznÄ›nÃ­
        G->>L: led_set_pixel_safe() - ZvÃ½raznÄ›nÃ­ e2 (zelenÃ¡) - NÃ¡vrat na pÅ¯vodnÃ­ pozici
        G->>L: led_set_pixel_safe() - ZobrazenÃ­ validnÃ­ch tahÅ¯ (zelenÃ¡)
        Note over M: HrÃ¡Ä vracÃ­ figurku na e2 nebo vybÃ­rÃ¡ validnÃ­ tah
    end

# =============================================================================
# 12. LED update cycle detail
# =============================================================================

sequenceDiagram
    participant G as gameTask
    participant L as ledTask
    participant LM as ledMutex
    participant HW as WS2812B_Hardware

    Note over L: LED task main loop - 33ms cyklus (30 FPS) - led_task_start()
    
    loop KaÅ¾dÃ½ cyklus (33ms)
        L->>L: esp_task_wdt_reset_safe() - Watchdog reset
        L->>L: led_process_commands() - ZpracovÃ¡nÃ­ pÅ™Ã­kazÅ¯ z fronty (pokud existuje)
        L->>L: led_update_animation() - Aktualizace animacÃ­
        L->>L: led_update_endgame_wave() - Non-blocking endgame animace
        L->>L: led_process_button_blink_timers() - Button LED feedback
        Note over L: Batch update systÃ©m - sbÃ­rÃ¡nÃ­ zmÄ›n
        L->>LM: xSemaphoreTake(led_unified_mutex, timeout) - ZÃ­skÃ¡nÃ­ mutexu
        activate LM
        L->>L: led_privileged_batch_commit() - Commit vÅ¡ech pending zmÄ›n
        Note over L: ProchÃ¡zenÃ­ led_changed_flags[] - pouze zmÄ›nÄ›nÃ© LED
        
        loop Pro kaÅ¾dou zmÄ›nÄ›nou LED
            L->>HW: led_strip_set_pixel() - NastavenÃ­ barvy LED v bufferu
            L->>L: led_changed_flags[i] = false - OznaÄenÃ­ jako zpracovÃ¡no
        end
        
        L->>HW: led_strip_refresh() - JEDEN refresh vÅ¡ech LED (timing-critical)
        Note over HW: WS2812B protokol - 800kHz, reset pulse - Hardware refresh
        L->>LM: xSemaphoreGive(led_unified_mutex) - UvolnÄ›nÃ­ mutexu
        deactivate LM
        L->>L: led_changes_pending = false
        L->>L: vTaskDelayUntil(33ms) - ÄŒekÃ¡nÃ­ na dalÅ¡Ã­ cyklus
    end
    
    Note over G: game_task volÃ¡ led_set_pixel_safe() - PÅ˜ÃMÃ‰ VOLÃNÃ s mutex ochranou
    G->>LM: xSemaphoreTake(led_unified_mutex, timeout)
    activate LM
    G->>L: led_set_pixel_internal() - NastavenÃ­ barvy v led_states[]
    G->>L: led_pending_changes[index] = color - PÅ™idÃ¡nÃ­ do batch bufferu
    G->>L: led_changed_flags[index] = true - OznaÄenÃ­ jako zmÄ›nÄ›no
    G->>L: led_changes_pending = true
    G->>LM: xSemaphoreGive(led_unified_mutex)
    deactivate LM
    
    Note over G,L: Batch systÃ©m: zmÄ›ny se sbÃ­rajÃ­ a commitujÃ­ v 33ms cyklu LED tasku

# =============================================================================
# 13. Matrix scanning detail (time-multiplexing)
# =============================================================================

sequenceDiagram
    participant MT as matrixTask
    participant FT as freeRTOS_Timer
    participant MM as matrixMutex
    participant BT as buttonTask
    participant GPIO as GPIO_Hardware

    Note over FT: FreeRTOS timer callback - matrix_scan_timer_callback() - PeriodickÃ© volÃ¡nÃ­
    
    loop KaÅ¾dÃ½ cyklus (25ms celkem)
        FT->>MT: matrix_scan_timer_callback() - Timer callback
        Note over MT: Time-multiplexing: 20ms matrix scanning, 5ms button scanning
        
        rect rgb(200, 220, 255)
            Note over MT,GPIO: Matrix scanning window (0-20ms)
            MT->>MM: xSemaphoreTake(matrix_mutex, timeout) - ZÃ­skÃ¡nÃ­ mutexu
            activate MM
            MT->>MT: matrix_scan_all() - SkenovÃ¡nÃ­ vÅ¡ech 8 Å™Ã¡dkÅ¯
            
            loop Pro kaÅ¾dÃ½ Å™Ã¡dek (0-7)
                MT->>GPIO: gpio_set_level(row_pin, LOW) - Aktivace Å™Ã¡dku
                MT->>GPIO: esp_rom_delay_us(2000) - 2ms stabilizace
                
                loop Pro kaÅ¾dÃ½ sloupec (0-7)
                    MT->>GPIO: gpio_get_level(col_pin) - ÄŒtenÃ­ Reed Switch
                    MT->>MT: matrix_state[row*8+col] = (pin_level == 0) ? 1 : 0
                end
                
                MT->>GPIO: gpio_config(row_pin, INPUT) - Deaktivace Å™Ã¡dku
            end
            
            MT->>MT: matrix_detect_moves() - Detekce zmÄ›n (piece_lifted, piece_placed)
            MT->>MT: memcpy(matrix_previous, matrix_state) - UloÅ¾enÃ­ stavu
            MT->>MM: xSemaphoreGive(matrix_mutex) - UvolnÄ›nÃ­ mutexu
            deactivate MM
        end
        
        rect rgb(255, 220, 200)
            Note over MT,BT: Button scanning window (20-25ms)
            MT->>MT: matrix_release_rows_for_buttons() - NastavenÃ­ vÅ¡ech row pinÅ¯ na HIGH
            MT->>BT: Button task mÅ¯Å¾e bezpeÄnÄ› ÄÃ­st column piny (GPIO 18-25)
            Note over BT: button_task scanuje tlaÄÃ­tka bÄ›hem tohoto okna
        end
    end
    
    Note over MT: Debouncing: kaÅ¾dÃ½ senzor musÃ­ bÃ½t stabilnÃ­ 3x za sebou pÅ™ed detekcÃ­ zmÄ›ny<br/>Move detection: piece_lifted â†’ piece_placed â†’ GAME_CMD_PICKUP/DROP pÅ™es game_command_queue
