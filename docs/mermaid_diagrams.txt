# Mermaid Sequence Diagramy pro CZECHMATE v2.4
# Vlo≈æte obsah tohoto souboru do https://mermaid.live/ pro vizualizaci
#
# Struktura:
# - ƒå√ÅST A: System Overview (1 diagram)
# - ƒå√ÅST B: Startup a inicializace (2-3 diagramy)
# - ƒå√ÅST C: Game Task - hlavn√≠ flow (5-7 diagram≈Ø)
# - ƒå√ÅST D: Tahy a komunikace (3 diagramy)
# - ƒå√ÅST E: Speci√°ln√≠ tahy (3 diagramy)
# - ƒå√ÅST F: Error handling (1 diagram)
# - ƒå√ÅST G: Endgame a Timer (2 diagramy)
# - ƒå√ÅST H: Hardware tasky - detail (4-5 diagram≈Ø)
# - ƒå√ÅST I: Web Server (2 diagramy)
# - ƒå√ÅST J: Test Task (2-3 diagramy)

# =============================================================================
# ƒå√ÅST A: SYSTEM OVERVIEW
# =============================================================================

# -----------------------------------------------------------------------------
# A1. System Architecture Overview
# -----------------------------------------------------------------------------
# Kompletn√≠ p≈ôehled architektury syst√©mu: v≈°echny tasky, jejich priority,
# stack sizes, fronty, mutexy a hlavn√≠ komunikaƒçn√≠ kan√°ly mezi tasky.

sequenceDiagram
    participant HW as ESP32_Hardware
    participant M as app_main
    participant LT as ledTask_P7_16KB
    participant MT as matrixTask_P6_8KB
    participant BT as buttonTask_P5_3KB
    participant GT as gameTask_P4_10KB
    participant UT as uartTask_P3_10KB
    participant AT as animationTask_P3_2KB
    participant WT as webServerTask_P3_20KB
    participant TT as testTask_P1_4KB
    participant GQ as gameCommandQueue_50
    participant BQ as buttonEventQueue_5
    participant AQ as animationCommandQueue_5
    participant URQ as uartResponseQueue
    participant LM as ledMutex
    participant MM as matrixMutex
    participant UM as uartMutex
    participant WDT as Watchdog

    Note over HW,M: ESP32-C6 Boot ‚Üí app_main() inicializace

    M->>WDT: esp_task_wdt_reconfigure(10s timeout)
    M->>WDT: esp_task_wdt_add(NULL) - Main task registrace

    Note over M: Vytvo≈ôen√≠ front a mutex≈Ø
    M->>GQ: xQueueCreate(50) - game_command_queue
    M->>BQ: xQueueCreate(5) - button_event_queue
    M->>AQ: xQueueCreate(5) - animation_command_queue
    M->>URQ: xQueueCreate(10) - uart_response_queue
    M->>LM: xSemaphoreCreateMutex() - led_mutex
    M->>MM: xSemaphoreCreateMutex() - matrix_mutex
    M->>UM: xSemaphoreCreateMutex() - uart_mutex

    Note over M: Vytv√°≈ôen√≠ task≈Ø podle priority (vzestupnƒõ: P1‚ÜíP7)
    M->>TT: xTaskCreate(test_task, P1, 4KB)
    M->>AT: xTaskCreate(animation_task, P3, 2KB)
    M->>WT: xTaskCreate(web_server_task, P3, 20KB)
    M->>UT: xTaskCreate(uart_task, P3, 10KB) - SUSPENDED
    M->>GT: xTaskCreate(game_task, P4, 10KB)
    M->>BT: xTaskCreate(button_task, P5, 3KB)
    M->>MT: xTaskCreate(matrix_task, P6, 8KB)
    M->>LT: xTaskCreate(led_task, P7, 16KB)

    Note over TT,LT: WDT registrace ka≈æd√©ho tasku (internƒõ)
    TT->>WDT: esp_task_wdt_add(NULL)
    AT->>WDT: esp_task_wdt_add(NULL)
    WT->>WDT: esp_task_wdt_add(NULL)
    GT->>WDT: esp_task_wdt_add(NULL)
    BT->>WDT: esp_task_wdt_add(NULL)
    MT->>WDT: esp_task_wdt_add(NULL)
    LT->>WDT: esp_task_wdt_add(NULL)

    Note over M: Boot animace a inicializace hry
    M->>LT: show_boot_animation_and_board()
    M->>GT: initialize_chess_game()
    M->>UT: vTaskResume(uart_task_handle)

    Note over M: FreeRTOS Scheduler p≈ôevezme ≈ô√≠zen√≠

    Note over MT,GT: Hlavn√≠ komunikaƒçn√≠ kan√°ly
    MT->>GQ: GAME_CMD_PICKUP/DROP (fyzick√© tahy)
    BT->>BQ: BUTTON_EVENT_PRESS (promoce, reset)
    GT->>AQ: Animation commands (endgame animace)
    UT->>GQ: GAME_CMD_MAKE_MOVE (UART tahy)
    WT->>GQ: GAME_CMD_MAKE_MOVE (Web tahy)
    GT->>URQ: Response messages (UART odpovƒõdi)
    GT->>LM: led_set_pixel_safe() - P≈ò√çM√â VOL√ÅN√ç s mutex
    GT->>MM: Matrix operations - s mutex ochranou
    UT->>UM: UART output - s mutex ochranou

    Note over GT: game_task hlavn√≠ smyƒçka (100ms):<br/>game_process_commands() ‚Üí game_update_timer_display() ‚Üí Auto new game detection
    Note over MT: matrix_task hlavn√≠ smyƒçka (25ms):<br/>Time-multiplexing: 20ms matrix scan, 5ms button scan
    Note over LT: led_task hlavn√≠ smyƒçka (33ms):<br/>Batch update syst√©m, WS2812B refresh
    Note over BT: button_task hlavn√≠ smyƒçka (5ms):<br/>GPIO scan, Debounce (50ms), Event detection
    Note over UT: uart_task hlavn√≠ smyƒçka (1ms):<br/>Input processing, Command parsing, Response queue
    Note over AT: animation_task hlavn√≠ smyƒçka (50ms):<br/>Animation frame execution, LED animace
    Note over WT: web_server_task hlavn√≠ smyƒçka:<br/>HTTP server, WiFi AP/STA, REST API
    Note over TT: test_task hlavn√≠ smyƒçka:<br/>Test execution, Hardware/System/Performance/Integration tests

# =============================================================================
# ƒå√ÅST B: STARTUP A INICIALIZACE
# =============================================================================

# -----------------------------------------------------------------------------
# B1. Startup sekvence
# -----------------------------------------------------------------------------
# Kompletn√≠ startup sekvence: od bootu ESP32 p≈ôes inicializaci NVS, vytvo≈ôen√≠
# front a mutex≈Ø, vytv√°≈ôen√≠ task≈Ø, boot animaci a≈æ po spu≈°tƒõn√≠ scheduleru.

sequenceDiagram
    participant HW as ESP32_Hardware
    participant M as app_main
    participant NVS as NVS_Flash
    participant Q as Queues
    participant MTX as Mutexes
    participant T as TaskCreation
    participant WDT as Watchdog
    participant LT as ledTask
    participant MT as matrixTask
    participant GT as gameTask
    participant UT as uartTask

    HW->>M: Boot ‚Üí app_main()
    Note over M: ESP32-C6 Chess v2.4 - Inicializace syst√©mu
    M->>WDT: esp_task_wdt_reconfigure() - 10s timeout (init)
    M->>WDT: esp_task_wdt_add(NULL) - Registrace main task
    M->>NVS: nvs_flash_init() - Non-Volatile Storage
    NVS-->>M: ESP_OK
    
    M->>Q: xQueueCreate(game_command_queue, 50)
    M->>Q: xQueueCreate(button_event_queue, 5)
    M->>Q: xQueueCreate(animation_command_queue, 5)
    M->>Q: xQueueCreate(uart_response_queue, 10)
    Q-->>M: Queue handles
    
    M->>MTX: xSemaphoreCreateMutex() - uart_mutex
    M->>MTX: xSemaphoreCreateMutex() - led_mutex
    M->>MTX: xSemaphoreCreateMutex() - matrix_mutex
    MTX-->>M: Mutex handles
    
    Note over T: Vytv√°≈ôen√≠ task≈Ø - v po≈ôad√≠ priority (P1‚ÜíP7)
    M->>T: xTaskCreate(test_task, P1, 4KB)
    M->>T: xTaskCreate(animation_task, P3, 2KB)
    M->>T: xTaskCreate(web_server_task, P3, 20KB)
    M->>T: xTaskCreate(uart_task, P3, 10KB) - SUSPENDED
    M->>T: xTaskCreate(game_task, P4, 10KB)
    M->>T: xTaskCreate(button_task, P5, 3KB)
    M->>T: xTaskCreate(matrix_task, P6, 8KB)
    M->>T: xTaskCreate(led_task, P7, 16KB)
    
    Note over M: vTaskDelay(1000ms) - ƒåek√°n√≠ na inicializaci task≈Ø
    M->>LT: show_boot_animation_and_board() - Boot animace
    M->>GT: initialize_chess_game() - Poƒç√°teƒçn√≠ pozice
    M->>UT: vTaskResume(uart_task_handle) - Resume po boot animaci
    M->>WDT: esp_task_wdt_reconfigure() - 8s timeout (normal)
    
    Note over M: FreeRTOS Scheduler - p≈ôevezme ≈ô√≠zen√≠<br/>app_main() NIKDY NEKONƒå√ç

# -----------------------------------------------------------------------------
# B2. Task inicializace detail
# -----------------------------------------------------------------------------
# Detailn√≠ inicializace ka≈æd√©ho tasku: vytvo≈ôen√≠, WDT registrace, vlastn√≠
# inicializace komponent (GPIO, hardware, state).

sequenceDiagram
    participant M as app_main
    participant LT as ledTask
    participant MT as matrixTask
    participant BT as buttonTask
    participant GT as gameTask
    participant UT as uartTask
    participant AT as animationTask
    participant WT as webServerTask
    participant TT as testTask
    participant WDT as Watchdog
    participant HW as Hardware

    Note over M: Vytv√°≈ôen√≠ a inicializace v≈°ech task≈Ø

    M->>LT: xTaskCreate(led_task, P7, 16KB)
    activate LT
    LT->>LT: led_task_start()
    LT->>HW: led_hardware_init() - WS2812B init, GPIO config
    LT->>WDT: esp_task_wdt_add(NULL) - WDT registrace
    deactivate LT

    M->>MT: xTaskCreate(matrix_task, P6, 8KB)
    activate MT
    MT->>MT: matrix_task_start()
    MT->>HW: matrix_reset() - GPIO init, Row/Column pins config
    MT->>HW: FreeRTOS timer init - matrix_scan_timer_callback (25ms)
    MT->>WDT: esp_task_wdt_add(NULL)
    deactivate MT

    M->>BT: xTaskCreate(button_task, P5, 3KB)
    activate BT
    BT->>BT: button_task_start()
    BT->>HW: GPIO config - Promotion buttons, Reset button
    BT->>WDT: esp_task_wdt_add(NULL)
    deactivate BT

    M->>GT: xTaskCreate(game_task, P4, 10KB)
    activate GT
    GT->>GT: game_task_start()
    GT->>GT: game_initialize() - Board init, State variables init
    GT->>WDT: esp_task_wdt_add(NULL)
    deactivate GT

    M->>UT: xTaskCreate(uart_task, P3, 10KB) - SUSPENDED
    activate UT
    UT->>UT: uart_task_start() - Poƒç√°teƒçn√≠ stav: SUSPENDED
    UT->>HW: UART/Console init (USB Serial JTAG)
    UT->>WDT: esp_task_wdt_add(NULL)
    Note over UT: Task je SUSPENDED - resume po boot animaci
    deactivate UT

    M->>AT: xTaskCreate(animation_task, P3, 2KB)
    activate AT
    AT->>AT: animation_task_start()
    AT->>AT: animation_initialize_system() - Animation buffers init
    AT->>WDT: esp_task_wdt_add(NULL)
    deactivate AT

    M->>WT: xTaskCreate(web_server_task, P3, 20KB)
    activate WT
    WT->>WT: web_server_task_start()
    WT->>HW: wifi_init_apsta() - WiFi AP setup (SSID: ESP32-CzechMate)
    WT->>WT: start_http_server() - HTTP server init, URI handlers
    WT->>WDT: esp_task_wdt_add(NULL)
    deactivate WT

    M->>TT: xTaskCreate(test_task, P1, 4KB)
    activate TT
    TT->>TT: test_task_start()
    TT->>TT: test_initialize_system() - Test suites init
    TT->>WDT: esp_task_wdt_add(NULL)
    deactivate TT

    Note over M: V≈°echny tasky vytvo≈ôeny a inicializov√°ny<br/>WDT registrov√°ny, hardware p≈ôipraven

# -----------------------------------------------------------------------------
# B3. Boot animation flow
# -----------------------------------------------------------------------------
# Flow boot animace: zobrazen√≠ ASCII art, progress bar, LED animace,
# inicializace hry a resume UART tasku.

sequenceDiagram
    participant M as app_main
    participant LT as ledTask
    participant GT as gameTask
    participant UT as uartTask
    participant GQ as gameCommandQueue
    participant HW as Hardware

    Note over M: Po vytvo≈ôen√≠ v≈°ech task≈Ø a vTaskDelay(1000ms)

    M->>LT: show_boot_animation_and_board()
    activate LT
    LT->>HW: printf() - ASCII art banner "CZECHMATE"
    LT->>LT: Progress bar animace (200 steps, 25ms/step)
    
    loop Progress bar (0-100%)
        LT->>LT: led_boot_animation_step(progress) - LED animace podle progress
        LT->>M: main_task_wdt_reset_safe() - WDT reset bƒõhem animace
        LT->>LT: vTaskDelay(25ms) - Smooth animation
    end
    
    LT->>LT: led_boot_animation_fade_out() - Fade out efekt
    LT->>HW: printf() - "Chess Engine Ready!"
    deactivate LT

    M->>GT: initialize_chess_game()
    activate GT
    GT->>GT: chess_move_command_t cmd - GAME_CMD_NEW_GAME
    GT->>GQ: xQueueSend(cmd) - Nov√° hra command
    activate GQ
    GT->>GQ: xQueueReceive() - game_task zpracuje NEW_GAME
    GT->>GT: game_start_new_game() - Board init, Starting position
    GT->>GT: led_show_chess_board() - Zobrazen√≠ poƒç√°teƒçn√≠ pozice
    deactivate GQ
    GT->>LT: led_update_button_availability_from_game() - Button LED feedback
    deactivate GT

    M->>UT: vTaskResume(uart_task_handle) - Resume UART task
    activate UT
    UT->>UT: uart_task_legacy_loop() - Start main loop
    UT->>HW: UART prompt, Command processing
    deactivate UT

    Note over M: Syst√©m p≈ôipraven - v≈°echny tasky bƒõ≈æ√≠<br/>Hra inicializov√°na, UART aktivn√≠

# =============================================================================
# ƒå√ÅST C: GAME TASK - HLAVN√ç FLOW
# =============================================================================

# -----------------------------------------------------------------------------
# C1. Game task main loop
# -----------------------------------------------------------------------------
# Hlavn√≠ smyƒçka game_task: zpracov√°n√≠ p≈ô√≠kaz≈Ø, timer update, auto new game
# detection, button events, WDT reset.

sequenceDiagram
    participant GT as gameTask
    participant GQ as gameCommandQueue
    participant BQ as buttonEventQueue
    participant WDT as Watchdog
    participant TS as TimerSystem

    Note over GT: game_task_start() - Hlavn√≠ smyƒçka (100ms cyklus)

    loop Ka≈æd√Ω cyklus (100ms)
        GT->>WDT: game_task_wdt_reset_safe() - WDT reset
        
        Note over GT: game_process_commands() - Zpracov√°n√≠ v≈°ech p≈ô√≠kaz≈Ø z fronty
        GT->>GQ: xQueueReceive(game_command_queue, 0) - Non-blocking
        activate GQ
        alt P≈ô√≠kaz dostupn√Ω
            GT->>GT: game_process_commands() - Switch podle command type:<br/>GAME_CMD_PICKUP, GAME_CMD_DROP, GAME_CMD_MAKE_MOVE,<br/>GAME_CMD_NEW_GAME, GAME_CMD_PROMOTION, GAME_CMD_TIMER_TIMEOUT, etc.
        end
        deactivate GQ
        
        Note over GT: Zpracov√°n√≠ button event≈Ø
        GT->>BQ: xQueueReceive(button_event_queue, 0) - Non-blocking
        activate BQ
        alt Button event dostupn√Ω
            GT->>GT: game_process_promotion_button() - Promotion buttons (0-3)<br/>game_reset_game() - Reset button (8)
        end
        deactivate BQ
        
        Note over GT: Timer update a kontrola timeout
        GT->>TS: game_update_timer_display() - Aktualizace zobrazen√≠ timeru
        TS->>TS: timer_check_timeout() - Kontrola vypr≈°en√≠ ƒçasu
        
        Note over GT: Endgame report handling
        opt endgame_report_requested == true
            GT->>GT: game_print_endgame_report_uart() - Asynchronn√≠ v√Ωpis
            GT->>GT: endgame_report_requested = false
        end
        
        Note over GT: Auto new game detection
        GT->>GT: game_is_board_in_starting_position() - Kontrola poƒç√°teƒçn√≠ pozice
        alt Pozice je startovn√≠ po dobu 2s
            GT->>GQ: xQueueSend(GAME_CMD_NEW_GAME) - Automatick√° nov√° hra
            activate GQ
            GT->>GQ: xQueueReceive() - Zpracov√°n√≠ NEW_GAME p≈ô√≠kazu
            GT->>GT: game_start_new_game() - Reset hry
            deactivate GQ
        end
        
        Note over GT: Periodic status log (ka≈æd√Ωch 5 sekund)
        opt loop_count % 5000 == 0
            GT->>GT: ESP_LOGI() - Status log (loop count, state, player, moves)
        end
        
        GT->>GT: vTaskDelayUntil(100ms) - ƒåek√°n√≠ na dal≈°√≠ cyklus
    end

# -----------------------------------------------------------------------------
# C2. game_process_commands() - kompletn√≠ flow
# -----------------------------------------------------------------------------
# Detailn√≠ flow zpracov√°n√≠ v≈°ech typ≈Ø p≈ô√≠kaz≈Ø z game_command_queue.

sequenceDiagram
    participant GQ as gameCommandQueue
    participant GT as gameTask
    participant L as ledTask
    participant U as uartTask
    participant URQ as uartResponseQueue
    participant TS as TimerSystem

    Note over GT: game_process_commands() - Zpracov√°n√≠ v≈°ech p≈ô√≠kaz≈Ø (MAX 15/cyklus)

    GT->>GT: game_update_error_blink() - Non-blocking blink update
    
    loop Zpracov√°n√≠ p≈ô√≠kaz≈Ø z fronty (a≈æ MAX_COMMANDS_PER_CYCLE=15)
        GT->>GQ: xQueueReceive(game_command_queue, 0) - Non-blocking
        activate GQ
        
        alt GAME_CMD_NEW_GAME (0)
            GT->>GT: game_start_new_game() - Reset board, Starting position
            GT->>L: led_show_chess_board() - Zobrazen√≠ poƒç√°teƒçn√≠ pozice
            GT->>URQ: xQueueSend("New game started!")
        else GAME_CMD_RESET_GAME (1)
            GT->>GT: game_reset_game() - Reset na poƒç√°teƒçn√≠ pozici
            GT->>URQ: xQueueSend("Game reset!")
        else GAME_CMD_MAKE_MOVE (2)
            GT->>GT: game_process_chess_move() - Validace a proveden√≠ tahu
        else GAME_CMD_PICKUP (7, 12)
            GT->>GT: game_process_pickup_command() - Zv√Ωraznƒõn√≠ zdroje, Validn√≠ tahy
        else GAME_CMD_DROP (8, 13)
            GT->>GT: game_process_drop_command() - Validace a proveden√≠ tahu
        else GAME_CMD_PROMOTION (9)
            GT->>GT: game_process_promotion_command() - Proveden√≠ promoce
        else GAME_CMD_GET_STATUS (4)
            GT->>GT: game_print_status() - UART v√Ωpis stavu
        else GAME_CMD_GET_BOARD (5, 11)
            GT->>URQ: xQueueSend(board representation) - ASCII board
        else GAME_CMD_SET_TIME_CONTROL (39)
            GT->>TS: game_process_timer_command() - Nastaven√≠ timeru
        else GAME_CMD_TIMER_TIMEOUT (44)
            GT->>GT: game_process_timer_command() - game_handle_time_expiration()
            GT->>GT: current_result_type = RESULT_WHITE_WINS / RESULT_BLACK_WINS
            GT->>L: start_endgame_animation()
        else GAME_CMD_CASTLE (21)
            GT->>GT: game_process_castle_command() - Ro≈°√°da
        else GAME_CMD_PROMOTE (22)
            GT->>GT: game_process_promote_command() - Promoce
        else Nezn√°m√Ω p≈ô√≠kaz
            GT->>GT: ESP_LOGW() - Unknown command type
        end
        
        GT->>GT: commands_processed++ - Kontrola limitu
        deactivate GQ
    end

# -----------------------------------------------------------------------------
# C3. game_is_valid_move() - validace tah≈Ø detail
# -----------------------------------------------------------------------------
# Kompletn√≠ flow validace tahu: kontrola hranic, vlastnictv√≠ figury, typ tahu,
# blokov√°n√≠ cesty, kontrola ≈°achu.

sequenceDiagram
    participant GT as gameTask
    participant Move as chess_move_t

    Note over GT: game_is_valid_move(move) - Kompletn√≠ validace tahu

    GT->>GT: Kontrola NULL pointeru
    alt move == NULL
        GT-->>Move: MOVE_ERROR_INVALID_MOVE_STRUCTURE
    end
    
    GT->>GT: game_is_valid_position(from/to) - Kontrola hranic (0-7)
    alt Sou≈ôadnice mimo hranice
        GT-->>Move: MOVE_ERROR_OUT_OF_BOUNDS
    end
    
    GT->>GT: game_active check
    alt Hra nen√≠ aktivn√≠
        GT-->>Move: MOVE_ERROR_GAME_NOT_ACTIVE
    end
    
    GT->>GT: source_piece = board[from_row][from_col]
    alt Zdrojov√© pole je pr√°zdn√©
        GT-->>Move: MOVE_ERROR_NO_PIECE
    end
    
    GT->>GT: Kontrola vlastnictv√≠ figury (current_player)
    alt Figurka nepat≈ô√≠ aktu√°ln√≠mu hr√°ƒçi
        GT-->>Move: MOVE_ERROR_WRONG_COLOR
    end
    
    GT->>GT: dest_piece = board[to_row][to_col]
    alt C√≠lov√© pole obsazen√© vlastn√≠ figurkou
        GT-->>Move: MOVE_ERROR_DESTINATION_OCCUPIED
    end
    
    Note over GT: Validace podle typu figury
    GT->>GT: game_validate_piece_move_enhanced(move, source_piece)
    alt PIECE_PAWN
        GT->>GT: game_validate_pawn_move_enhanced() - Forward, Capture, En passant
    else PIECE_KNIGHT
        GT->>GT: game_validate_knight_move_enhanced() - L-shape
    else PIECE_BISHOP
        GT->>GT: game_validate_bishop_move_enhanced() - Diagonal, Path check
    else PIECE_ROOK
        GT->>GT: game_validate_rook_move_enhanced() - Horizontal/Vertical, Path check
    else PIECE_QUEEN
        GT->>GT: game_validate_queen_move_enhanced() - Combined Rook+Bishop
    else PIECE_KING
        GT->>GT: game_validate_king_move_enhanced() - 1 square, Castling
    end
    
    GT->>GT: Kontrola ro≈°√°dy v progress
    alt castling_state.in_progress
        GT->>GT: Kontrola spr√°vn√©ho tahu vƒõ≈æe (rook_from ‚Üí rook_to)
        alt Nespr√°vn√Ω tah vƒõ≈æe
            GT-->>Move: MOVE_ERROR_CASTLING_BLOCKED
        end
    end
    
    GT->>GT: game_would_move_leave_king_in_check(move) - Kontrola ≈°achu
    alt Tah by nechal kr√°le v ≈°achu
        GT-->>Move: MOVE_ERROR_KING_IN_CHECK
    end
    
    GT-->>Move: MOVE_ERROR_NONE - Tah je validn√≠

# -----------------------------------------------------------------------------
# C4. game_execute_move() - proveden√≠ tahu detail
# -----------------------------------------------------------------------------
# Kompletn√≠ flow proveden√≠ tahu: detekce typu tahu, aktualizace board,
# historie, speci√°ln√≠ p≈ô√≠pady (castling, en passant, promotion), kontrola endgame.

sequenceDiagram
    participant GT as gameTask
    participant Move as chess_move_t
    participant L as ledTask
    participant TS as TimerSystem

    Note over GT: game_execute_move(move) - Proveden√≠ validn√≠ho tahu

    GT->>GT: game_is_valid_move(move) - Validace (mus√≠ b√Ωt MOVE_ERROR_NONE)
    
    GT->>GT: source_piece = board[from_row][from_col]<br/>dest_piece = board[to_row][to_col]
    
    Note over GT: Vytvo≈ôen√≠ extended_move struktury
    GT->>GT: chess_move_extended_t extended_move - Inicializace
    
    Note over GT: Detekce typu tahu (pokud nen√≠ error recovery)
    opt !error_recovery_state.waiting_for_move_correction
        GT->>GT: Detekce ro≈°√°dy (king move 2 squares)
        alt Castling
            GT->>GT: extended_move.move_type = MOVE_TYPE_CASTLE_KING/QUEEN
        end
        
        GT->>GT: Detekce en passant (pawn diagonal capture na pr√°zdn√© pole)
        alt En passant
            GT->>GT: extended_move.move_type = MOVE_TYPE_EN_PASSANT
        end
        
        GT->>GT: Detekce promoce (pawn na posledn√≠ ≈ôadƒõ)
        alt Promotion
            GT->>GT: extended_move.move_type = MOVE_TYPE_PROMOTION
        end
        
        GT->>GT: Detekce bran√≠ (dest_piece != EMPTY)
        alt Capture
            GT->>GT: extended_move.move_type = MOVE_TYPE_CAPTURE<br/>add_captured_piece(dest_piece)
        end
    end
    
    Note over GT: Aktualizace board[][]
    GT->>GT: board[to_row][to_col] = source_piece<br/>board[from_row][from_col] = PIECE_EMPTY
    
    Note over GT: Speci√°ln√≠ p≈ô√≠pady
    opt Castling
        GT->>GT: Board update pro vƒõ≈æ (rook from/to)
        GT->>GT: white_king_moved = true / black_king_moved = true<br/>white_rook_*_moved = true / black_rook_*_moved = true
    end
    
    opt En passant
        GT->>GT: board[victim_row][victim_col] = PIECE_EMPTY - Odstranƒõn√≠ pƒõ≈°ce
    end
    
    opt Promotion
        GT->>GT: board[to_row][to_col] = PROMOTION_QUEEN (default)
    end
    
    Note over GT: Aktualizace historie a stavu
    GT->>GT: move_history[history_index++] = extended_move<br/>move_count++<br/>moves_without_capture++ (pokud nen√≠ capture)
    
    GT->>GT: timer_switch_player() - Zmƒõna hr√°ƒçe v timeru
    GT->>TS: timer_get_state() - Aktualizace timer display
    
    GT->>L: led_execute_command_new(LED_CMD_ANIM_MOVE_PATH) - Move path animace
    
    GT->>GT: game_check_end_game_conditions() - Kontrola ≈°ach/mat/rem√≠za
    
    GT->>GT: current_player = opposite_player - Zmƒõna hr√°ƒçe
    GT->>L: led_update_button_availability_from_game() - Button LED feedback
    
    GT-->>Move: true - Tah √∫spƒõ≈°nƒõ proveden

# =============================================================================
# ƒå√ÅST D: TAHY A KOMUNIKACE
# =============================================================================

# -----------------------------------------------------------------------------
# D1. Fyzick√Ω tah (Matrix ‚Üí Game ‚Üí LED)
# -----------------------------------------------------------------------------
# Kompletn√≠ flow fyzick√©ho tahu: skenov√°n√≠ matice, detekce pohybu, pickup/drop,
# validace, proveden√≠, LED animace.

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask
    participant A as animationTask
    participant AQ as animationCommandQueue

    Note over M: Skenov√°n√≠ 8x8 matice p≈ôes FreeRTOS timer<br/>Detekce Reed Switch≈Ø pomoc√≠ time-multiplexingu
    
    M->>M: matrix_scan_all() - Sken v≈°ech ≈ô√°dk≈Ø s mutex ochranou, Debounce (3x sken)
    M->>M: matrix_detect_moves() - Detekce zmƒõn, piece_lifted detected (e2)
    M->>GQ: xQueueSend(GAME_CMD_PICKUP) from: e2
    activate GQ
    G->>GQ: xQueueReceive() - zpracov√°n√≠ p≈ô√≠kaz≈Ø z FIFO fronty
    deactivate GQ
    
    Note over G: game_process_commands() - game_process_pickup_command() - Validace figurky
    G->>G: Kontrola, zda je tah mo≈æn√Ω - game_get_available_moves()
    G->>L: led_set_pixel_safe() - Zv√Ωraznƒõn√≠ zdroje (≈ælut√°) - P≈ò√çM√â VOL√ÅN√ç s led_mutex
    G->>L: led_set_pixel_safe() - Zobrazen√≠ validn√≠ch tah≈Ø (zelen√°)
    
    Note over L: LED batch update syst√©m - led_commit_pending_changes()<br/>WS2812B refresh (33ms cyklus)
    
    M->>M: matrix_scan_all() - Dal≈°√≠ sken (time-multiplexing: 20ms matrix, 5ms buttons)
    M->>M: matrix_detect_moves() - piece_placed detected (e4)
    M->>GQ: xQueueSend(GAME_CMD_DROP) from: e2, to: e4
    activate GQ
    G->>GQ: xQueueReceive() - zpracov√°n√≠ DROP p≈ô√≠kazu
    deactivate GQ
    
    Note over G: game_process_drop_command() - Validace tahu - game_is_valid_move()<br/>Kontrola ≈°achov√Ωch pravidel
    
    alt Tah je validn√≠
        G->>G: game_execute_move() - Aktualizace board[][] - Zmƒõna hr√°ƒçe - Kontrola ≈°ach/mat
        G->>L: led_execute_command_new() - LED_CMD_ANIM_MOVE_PATH - P≈ò√çM√â VOL√ÅN√ç
        Note over L: Move path animace - ≈ælut√° ‚Üí zelen√° p≈ôechod
        
        opt Endgame detekov√°n (≈°achmat/pat/rem√≠za)
            G->>AQ: xQueueSend() - animation command pro endgame animaci
            activate AQ
            A->>AQ: xQueueReceive()
            deactivate AQ
            A->>L: led_set_pixel_safe() - Endgame wave animace
        end
        
        G->>L: led_clear_board_only() - Zhasnut√≠ zv√Ωraznƒõn√≠
    else Tah nen√≠ validn√≠
        G->>L: led_set_pixel_safe() - ƒåerven√° (chyba) - Zdroj + c√≠l - Error handling flow
        Note over G: Error recovery state aktivn√≠ - ƒçek√°n√≠ na korekci tahu
        G->>L: led_clear_board_only() - Po n√°vratu figurky zhasnut√≠
    end
    
    Note over L: Kontinu√°ln√≠ LED update - 33ms cyklus - Batch commit zmƒõn - led_privileged_batch_commit()

# -----------------------------------------------------------------------------
# D2. Tah p≈ôes UART
# -----------------------------------------------------------------------------
# Flow tahu p≈ôes UART: parsov√°n√≠ p≈ô√≠kazu, validace, proveden√≠, odpovƒõƒè.

sequenceDiagram
    participant U as uartTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask
    participant URQ as uartResponseQueue

    Note over U: uart_task_legacy_loop() - ƒåten√≠ znak≈Ø z UART - Parsov√°n√≠ p≈ô√≠kaz≈Ø
    U->>U: uart_process_input() - "move e2e4"
    U->>U: uart_parse_command() - Parsov√°n√≠ "move" p≈ô√≠kazu
    U->>U: uart_cmd_move() - Validace notace - P≈ôevod na chess_move_command_t
    U->>GQ: xQueueSend(GAME_CMD_MAKE_MOVE) from: e2, to: e4 - response_queue: uart_response_queue
    activate GQ
    G->>GQ: xQueueReceive() - zpracov√°n√≠ p≈ô√≠kaz≈Ø
    deactivate GQ
    
    Note over G: game_process_commands() - game_process_chess_move()
    G->>G: convert_notation_to_coords() - P≈ôevod e2‚Üí[1,4], e4‚Üí[3,4]
    G->>G: game_is_valid_move() - Validace ≈°achov√Ωch pravidel
    
    alt Tah je validn√≠
        G->>L: led_set_pixel_safe() - Zv√Ωraznƒõn√≠ zdroje (≈ælut√°)
        G->>L: game_get_available_moves() - Zobrazen√≠ validn√≠ch tah≈Ø
        G->>G: game_execute_move() - Aktualizace board[][] - Zmƒõna hr√°ƒçe
        G->>L: led_execute_command_new() - LED_CMD_ANIM_MOVE_PATH
        Note over L: Move path animace - ≈ælut√° ‚Üí zelen√°
        G->>G: game_check_end_game_conditions() - ≈†ach? Mat? Rem√≠za?
        G->>URQ: xQueueSend(response) - "‚úÖ MOVE EXECUTED"
        activate URQ
        U->>URQ: xQueueReceive()
        deactivate URQ
        U->>U: uart_send_formatted() - V√Ωpis v√Ωsledku - pomoc√≠ uart_mutex
    else Tah nen√≠ validn√≠
        G->>URQ: xQueueSend(error_response) - "‚ùå Invalid move"
        activate URQ
        U->>URQ: xQueueReceive()
        deactivate URQ
        U->>U: uart_send_error() - V√Ωpis chyby
    end

# -----------------------------------------------------------------------------
# D3. Button Events a Promoce
# -----------------------------------------------------------------------------
# Flow button event≈Ø: GPIO scan, debounce, button event queue, zpracov√°n√≠
# promoce/reset v game_task.

sequenceDiagram
    participant BT as buttonTask
    participant BQ as buttonEventQueue
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over BT: Hardware GPIO scan - Button press detection - 5ms cyklus
    BT->>BT: button_process_events() - GPIO scan - Debounce kontrola (50ms)
    BT->>BT: button_handle_press() - button_id: QUEEN (0)
    BT->>BQ: xQueueSend(BUTTON_EVENT_PRESS) - button_id: 0 (QUEEN)
    activate BQ
    G->>BQ: xQueueReceive(button_event_queue)
    deactivate BQ
    
    Note over G: game_process_commands() - Zpracov√°n√≠ button event≈Ø
    
    opt Promotion button
        G->>G: game_process_promotion_button(0) - choice = PROMOTION_QUEEN
        Note over G: game_process_promotion_command() - Promoce pƒõ≈°ce - Aktualizace board[][]
        G->>L: led_set_pixel_safe() - Promoƒçn√≠ animace - P≈ò√çM√â VOL√ÅN√ç
        G->>G: game_check_end_game_conditions()
    end
    
    opt Reset button
        G->>G: game_reset_game() - Reset na poƒç√°teƒçn√≠ pozici
        G->>L: led_show_chess_board() - Zobrazen√≠ poƒç√°teƒçn√≠ pozice
    end
    
    Note over L: Button LED feedback - Zelen√°/Modr√°/ƒåerven√° - podle dostupnosti

# =============================================================================
# ƒå√ÅST E: SPECI√ÅLN√ç TAHY
# =============================================================================

# -----------------------------------------------------------------------------
# E1. Promotion flow (kompletn√≠)
# -----------------------------------------------------------------------------
# Kompletn√≠ flow promoce: detekce, ƒçek√°n√≠ na v√Ωbƒõr, fyzick√© tlaƒç√≠tko/UART,
# proveden√≠ promoce.

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask
    participant BQ as buttonEventQueue
    participant BT as buttonTask
    participant U as uartTask

    Note over M: Pƒõ≈°ec dos√°hl posledn√≠ ≈ôady
    M->>GQ: GAME_CMD_DROP - from: e7, to: e8
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    
    Note over G: game_process_drop_command() - game_execute_move()
    G->>G: game_check_promotion_needed() - board[7][col] == PAWN
    
    alt Pƒõ≈°ec na posledn√≠ ≈ôadƒõ
        G->>G: promotion_state.pending = true - promotion_state.square = e8 - promotion_state.player = WHITE
        G->>L: led_set_pixel_safe() - LED 64-67: ZELEN√Å (White) - LED 68-71: MODR√Å (Black)
        G->>U: printf() - "üëë PAWN PROMOTION AVAILABLE!" - Menu s mo≈ænostmi
        Note over G: Matrix events PAUSED - ƒåek√°n√≠ na v√Ωbƒõr figury
        
        par Fyzick√© tlaƒç√≠tko
            BT->>BQ: BUTTON_EVENT_PRESS - button_id: 0 (QUEEN)
            activate BQ
            G->>BQ: xQueueReceive(button_event_queue)
            deactivate BQ
            G->>G: game_process_promotion_button(0) - choice = PROMOTION_QUEEN
        and UART p≈ô√≠kaz
            U->>GQ: GAME_CMD_PROMOTION - square: e8, piece: QUEEN
            activate GQ
            G->>GQ: xQueueReceive()
            deactivate GQ
            G->>G: game_process_promotion_command() - choice = PROMOTION_QUEEN
        end
        
        G->>G: game_execute_promotion(choice) - board[7][4] = PIECE_WHITE_QUEEN
        G->>L: led_set_pixel_safe() - Promoƒçn√≠ animace - Pestr√© efekty
        G->>G: promotion_state.pending = false - Matrix events RESUMED
        G->>G: game_check_end_game_conditions() - Kontrola ≈°ach/mat
        G->>G: current_player = BLACK - Zmƒõna hr√°ƒçe
    end

# -----------------------------------------------------------------------------
# E2. Castling flow (dvouf√°zov√Ω)
# -----------------------------------------------------------------------------
# Kompletn√≠ flow ro≈°√°dy: detekce kr√°lovsk√©ho tahu, ƒçek√°n√≠ na vƒõ≈æ, validace,
# dokonƒçen√≠ ro≈°√°dy.

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over M: Hr√°ƒç zved√° kr√°le z e1
    M->>GQ: GAME_CMD_PICKUP - from: e1
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    G->>G: game_process_pickup_command() - Zv√Ωraznƒõn√≠ e1
    
    Note over M: Hr√°ƒç pokl√°d√° kr√°le na g1 (kingside)
    M->>GQ: GAME_CMD_DROP - from: e1, to: g1
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    
    Note over G: game_process_drop_command() - Detekce ro≈°√°dy: king move 2 squares
    G->>G: game_is_valid_move() - Kontrola ro≈°√°dov√Ωch podm√≠nek:<br/>Kr√°l a vƒõ≈æ se neh√Ωbaly, Pole mezi nimi pr√°zdn√°,<br/>Kr√°l nen√≠ v ≈°achu, Pole nejsou napaden√°
    
    alt Ro≈°√°da validn√≠
        G->>G: game_execute_move() - board[0][4] = EMPTY - board[0][6] = KING
        G->>G: castling_state.in_progress = true - castling_state.rook_from = h1 - castling_state.rook_to = f1
        G->>L: led_set_pixel_safe() - Zv√Ωraznƒõn√≠ vƒõ≈æe h1 (≈ælut√°) - Zv√Ωraznƒõn√≠ f1 (zelen√°)
        G->>L: game_start_repeating_rook_animation() - Opakuj√≠c√≠ se animace pohybu vƒõ≈æe
        Note over G: ƒåek√°n√≠ na pohyb vƒõ≈æe - Matrix events st√°le aktivn√≠
        
        M->>GQ: GAME_CMD_PICKUP - from: h1
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        M->>GQ: GAME_CMD_DROP - from: h1, to: f1
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        
        G->>G: game_check_castling_completion() - Kontrola spr√°vn√©ho tahu vƒõ≈æe
        
        alt Vƒõ≈æ na spr√°vn√© pozici
            G->>G: board[0][7] = EMPTY - board[0][5] = ROOK
            G->>G: white_king_moved = true - white_rook_h_moved = true
            G->>L: show_castling_completion_animation() - Zlat√° animace
            G->>G: castling_state.in_progress = false - current_player = BLACK
            G->>G: game_check_end_game_conditions()
        else Vƒõ≈æ na ≈°patn√© pozici
            G->>L: led_set_pixel_safe() - ƒåerven√° (chyba)
            Note over G: ƒåek√° na spr√°vn√Ω tah vƒõ≈æe
        end
    end

# -----------------------------------------------------------------------------
# E3. En passant flow (br√°n√≠ mimochodem)
# -----------------------------------------------------------------------------
# Flow en passant: detekce dvojit√©ho tahu pƒõ≈°ce, nastaven√≠ en passant stavu,
# proveden√≠ bran√≠ mimochodem.

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over M: Prvn√≠ tah: B√≠l√Ω pƒõ≈°ec se pohybuje o 2 pole (e2‚Üíe4)
    M->>GQ: GAME_CMD_DROP - from: e2, to: e4
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    G->>G: game_execute_move() - Detekce dvojit√©ho tahu pƒõ≈°ce
    G->>G: en_passant_available = true - en_passant_target_row = 3 - en_passant_target_col = 4 - en_passant_victim_row = 1 - en_passant_victim_col = 4
    
    Note over M: Druh√Ω tah: ƒåern√Ω pƒõ≈°ec na d4 br√°n√≠ mimochodem (d4‚Üíe3)
    M->>GQ: GAME_CMD_DROP - from: d4, to: e3
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    G->>G: game_process_drop_command() - game_is_valid_move()
    G->>G: Detekce en passant: pawn diagonal capture na pr√°zdn√© pole<br/>en_passant_available == true - to_col == en_passant_target_col
    
    alt En passant validn√≠
        G->>G: game_execute_move() - board[3][4] = PIECE_BLACK_PAWN - board[1][4] = PIECE_EMPTY - board[4][4] = PIECE_EMPTY
        G->>L: led_execute_command_new() - LED_CMD_ANIM_MOVE_PATH - Speci√°ln√≠ animace pro en passant
        G->>G: en_passant_available = false - Reset stavu
        G->>G: game_check_end_game_conditions()
        G->>G: current_player = WHITE
    else En passant nevalidn√≠
        G->>L: led_set_pixel_safe() - ƒåerven√° (chyba)
        Note over G: Norm√°ln√≠ error handling flow
    end

# =============================================================================
# ƒå√ÅST F: ERROR HANDLING
# =============================================================================

# -----------------------------------------------------------------------------
# F1. Error handling flow
# -----------------------------------------------------------------------------
# Kompletn√≠ flow error handlingu: detekce nevalidn√≠ho tahu, error recovery
# state, ƒçek√°n√≠ na korekci, recovery.

sequenceDiagram
    participant M as matrixTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over M: Hr√°ƒç provede nevalidn√≠ tah (e2‚Üíe5 - pƒõ≈°ec o 3 pole)
    M->>GQ: GAME_CMD_DROP - from: e2, to: e5
    activate GQ
    G->>GQ: xQueueReceive()
    deactivate GQ
    G->>G: game_process_drop_command() - game_is_valid_move()
    
    alt Tah nen√≠ validn√≠
        G->>G: error_recovery_state.waiting_for_move_correction = true - error_recovery_state.last_invalid_from = e2 - error_recovery_state.last_invalid_to = e5
        G->>L: led_set_pixel_safe() - ƒåerven√° na zdroj (e2) a c√≠l (e5) - Blink animace
        G->>L: game_start_error_blink() - Non-blocking blink (500ms)
        Note over G: Error recovery state aktivn√≠ - Matrix events st√°le aktivn√≠
        
        Note over M: Hr√°ƒç vr√°t√≠ figurku zpƒõt na e2
        M->>GQ: GAME_CMD_DROP - from: e5, to: e2
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        G->>G: game_process_drop_command() - Detekce n√°vratu na last_invalid_from
        G->>G: error_recovery_state.waiting_for_move_correction = false - Reset error state
        G->>L: led_clear_board_only() - Zhasnut√≠ zv√Ωraznƒõn√≠
        G->>L: game_stop_error_blink() - Zastaven√≠ blink animace
        Note over G: Error recovery dokonƒçen - Norm√°ln√≠ hra pokraƒçuje
    end

# =============================================================================
# ƒå√ÅST G: ENDGAME A TIMER
# =============================================================================

# -----------------------------------------------------------------------------
# G1. Endgame detection flow
# -----------------------------------------------------------------------------
# Kompletn√≠ flow detekce endgame: kontrola ≈°ach/mat, rem√≠za (stalemate, 50-move,
# threefold repetition, insufficient material), aktualizace statistik, animace.

sequenceDiagram
    participant G as gameTask
    participant L as ledTask
    participant AQ as animationCommandQueue
    participant A as animationTask
    participant U as uartTask
    participant WS as webServerTask
    participant TS as TimerSystem

    Note over G: Po ka≈æd√©m tahu: game_check_end_game_conditions()
    G->>G: game_is_king_in_check(current_player) - Kontrola ≈°achu
    G->>G: game_has_legal_moves(current_player) - Kontrola validn√≠ch tah≈Ø
    
    alt ≈†ach + ≈æ√°dn√© tahy (Checkmate)
        G->>G: current_result_type = RESULT_BLACK_WINS / RESULT_WHITE_WINS
        G->>G: game_update_endgame_statistics() - Aktualizace statistik
        G->>TS: timer_pause() - Zastaven√≠ hodin
        G->>L: start_endgame_animation() - ENDGAME_ANIM_VICTORY_WAVE - Vlnov√Ω efekt
        G->>U: game_print_endgame_report_uart() - Kompletn√≠ report
        G->>WS: game_get_status_json() - JSON s game_state="finished"
        Note over G: Rozli≈°en√≠ typu ≈°achmatu: En passant, Castling, Promotion, Discovered check
    else Nen√≠ ≈°ach + ≈æ√°dn√© tahy (Stalemate)
        G->>G: current_result_type = RESULT_DRAW_STALEMATE
        G->>G: game_update_endgame_statistics()
        G->>TS: timer_pause()
        G->>L: start_endgame_animation() - ENDGAME_ANIM_DRAW
        G->>U: game_print_endgame_report_uart()
    else 50-Move Rule
        G->>G: moves_without_capture >= 100 - Kontrola poƒç√≠tadla
        G->>G: current_result_type = RESULT_DRAW_50_MOVE
        G->>G: game_update_endgame_statistics()
        G->>TS: timer_pause()
        G->>L: start_endgame_animation()
        G->>U: game_print_endgame_report_uart()
    else Threefold Repetition
        G->>G: game_is_position_repeated() - Kontrola historie pozic
        G->>G: current_result_type = RESULT_DRAW_REPETITION
        G->>G: game_update_endgame_statistics()
        G->>TS: timer_pause()
        G->>L: start_endgame_animation()
        G->>U: game_print_endgame_report_uart()
    else Insufficient Material
        G->>G: game_is_insufficient_material() - King vs King, King+Bishop, etc.
        G->>G: current_result_type = RESULT_DRAW_INSUFFICIENT
        G->>G: game_update_endgame_statistics()
        G->>TS: timer_pause()
        G->>L: start_endgame_animation()
        G->>U: game_print_endgame_report_uart()
    end
    
    Note over G: current_game_state = GAME_STATE_FINISHED - Hra ukonƒçena

# -----------------------------------------------------------------------------
# G2. Timer timeout flow
# -----------------------------------------------------------------------------
# Flow timeout timeru: kontrola vypr≈°en√≠ ƒçasu, timeout event, urƒçen√≠ v√≠tƒõze,
# endgame handling.

sequenceDiagram
    participant TS as timerSystem
    participant G as gameTask
    participant GQ as gameCommandQueue
    participant L as ledTask
    participant U as uartTask

    Note over TS: Timer bƒõ≈æ√≠ pro aktu√°ln√≠ho hr√°ƒçe
    TS->>TS: timer_check_timeout() - Kontrola ka≈ædou sekundu
    
    alt ƒåas vypr≈°el
        TS->>GQ: xQueueSend(GAME_CMD_TIMER_TIMEOUT) - Timeout event
        activate GQ
        G->>GQ: xQueueReceive()
        deactivate GQ
        
        Note over G: game_process_timer_command() - game_handle_time_expiration()
        G->>TS: timer_get_state() - Z√≠sk√°n√≠ stavu timeru
        TS-->>G: timer_data.is_white_turn
        G->>G: winner = opposite_player - Urƒçen√≠ v√≠tƒõze
        G->>G: current_game_state = GAME_STATE_FINISHED<br/>current_result_type = RESULT_WHITE_WINS / RESULT_BLACK_WINS<br/>current_endgame_reason = ENDGAME_REASON_TIMEOUT
        G->>G: game_update_endgame_statistics() - Aktualizace statistik
        G->>TS: timer_pause() - Zastaven√≠ timeru
        G->>L: start_endgame_animation() - ENDGAME_ANIM_VICTORY_WAVE - Vlnov√Ω efekt pro v√≠tƒõze
        G->>U: game_print_endgame_report_uart() - "üèÜ White wins by timeout!"
        Note over G: endgame_report_requested = true - Pro asynchronn√≠ v√Ωpis
    end
    
    Note over G: game_update_timer_display() - Vol√°no ka≈æd√Ω cyklus - game_task main loop

# =============================================================================
# ƒå√ÅST H: HARDWARE TASKY - DETAIL
# =============================================================================

# -----------------------------------------------------------------------------
# H1. LED update cycle detail
# -----------------------------------------------------------------------------
# Detailn√≠ flow LED tasku: batch update syst√©m, WS2812B refresh, mutex ochrana.

sequenceDiagram
    participant G as gameTask
    participant L as ledTask
    participant LM as ledMutex
    participant HW as WS2812B_Hardware

    Note over L: LED task main loop - 33ms cyklus (30 FPS) - led_task_start()
    
    loop Ka≈æd√Ω cyklus (33ms)
        L->>L: esp_task_wdt_reset_safe() - Watchdog reset
        L->>L: led_process_commands() - Zpracov√°n√≠ p≈ô√≠kaz≈Ø z fronty (pokud existuje)
        L->>L: led_update_animation() - Aktualizace animac√≠
        L->>L: led_update_endgame_wave() - Non-blocking endgame animace
        L->>L: led_process_button_blink_timers() - Button LED feedback
        Note over L: Batch update syst√©m - sb√≠r√°n√≠ zmƒõn
        L->>LM: xSemaphoreTake(led_unified_mutex, timeout) - Z√≠sk√°n√≠ mutexu
        activate LM
        L->>L: led_privileged_batch_commit() - Commit v≈°ech pending zmƒõn
        Note over L: Proch√°zen√≠ led_changed_flags[] - pouze zmƒõnƒõn√© LED
        
        loop Pro ka≈ædou zmƒõnƒõnou LED
            L->>HW: led_strip_set_pixel() - Nastaven√≠ barvy LED v bufferu
            L->>L: led_changed_flags[i] = false - Oznaƒçen√≠ jako zpracov√°no
        end
        
        L->>HW: led_strip_refresh() - JEDEN refresh v≈°ech LED (timing-critical)
        Note over HW: WS2812B protokol - 800kHz, reset pulse - Hardware refresh
        L->>LM: xSemaphoreGive(led_unified_mutex) - Uvolnƒõn√≠ mutexu
        deactivate LM
        L->>L: led_changes_pending = false
        L->>L: vTaskDelayUntil(33ms) - ƒåek√°n√≠ na dal≈°√≠ cyklus
    end
    
    Note over G: game_task vol√° led_set_pixel_safe() - P≈ò√çM√â VOL√ÅN√ç s mutex ochranou
    G->>LM: xSemaphoreTake(led_unified_mutex, timeout)
    activate LM
    G->>L: led_set_pixel_internal() - Nastaven√≠ barvy v led_states[]
    G->>L: led_pending_changes[index] = color - P≈ôid√°n√≠ do batch bufferu
    G->>L: led_changed_flags[index] = true - Oznaƒçen√≠ jako zmƒõnƒõno
    G->>L: led_changes_pending = true
    G->>LM: xSemaphoreGive(led_unified_mutex)
    deactivate LM
    
    Note over G,L: Batch syst√©m: zmƒõny se sb√≠raj√≠ a commituj√≠ v 33ms cyklu LED tasku

# -----------------------------------------------------------------------------
# H2. Matrix scanning detail (time-multiplexing)
# -----------------------------------------------------------------------------
# Detailn√≠ flow matrix tasku: time-multiplexing, skenov√°n√≠ Reed Switch≈Ø,
# debounce, detekce pohybu.

sequenceDiagram
    participant MT as matrixTask
    participant FT as freeRTOS_Timer
    participant MM as matrixMutex
    participant BT as buttonTask
    participant GPIO as GPIO_Hardware

    Note over FT: FreeRTOS timer callback - matrix_scan_timer_callback() - Periodick√© vol√°n√≠
    
    loop Ka≈æd√Ω cyklus (25ms celkem)
        FT->>MT: matrix_scan_timer_callback() - Timer callback
        Note over MT: Time-multiplexing: 20ms matrix scanning, 5ms button scanning
        
        rect rgb(200, 220, 255)
            Note over MT,GPIO: Matrix scanning window (0-20ms)
            MT->>MM: xSemaphoreTake(matrix_mutex, timeout) - Z√≠sk√°n√≠ mutexu
            activate MM
            MT->>MT: matrix_scan_all() - Skenov√°n√≠ v≈°ech 8 ≈ô√°dk≈Ø
            
            loop Pro ka≈æd√Ω ≈ô√°dek (0-7)
                MT->>GPIO: gpio_set_level(row_pin, LOW) - Aktivace ≈ô√°dku
                MT->>GPIO: esp_rom_delay_us(2000) - 2ms stabilizace
                
                loop Pro ka≈æd√Ω sloupec (0-7)
                    MT->>GPIO: gpio_get_level(col_pin) - ƒåten√≠ Reed Switch
                    MT->>MT: matrix_state[row*8+col] = (pin_level == 0) ? 1 : 0
                end
                
                MT->>GPIO: gpio_config(row_pin, INPUT) - Deaktivace ≈ô√°dku
            end
            
            MT->>MT: matrix_detect_moves() - Detekce zmƒõn (piece_lifted, piece_placed)
            MT->>MT: memcpy(matrix_previous, matrix_state) - Ulo≈æen√≠ stavu
            MT->>MM: xSemaphoreGive(matrix_mutex) - Uvolnƒõn√≠ mutexu
            deactivate MM
        end
        
        rect rgb(255, 220, 200)
            Note over MT,BT: Button scanning window (20-25ms)
            MT->>MT: matrix_release_rows_for_buttons() - Nastaven√≠ v≈°ech row pin≈Ø na HIGH
            MT->>BT: Button task m≈Ø≈æe bezpeƒçnƒõ ƒç√≠st column piny (GPIO 18-25)
            Note over BT: button_task scanuje tlaƒç√≠tka bƒõhem tohoto okna
        end
    end
    
    Note over MT: Debouncing: ka≈æd√Ω senzor mus√≠ b√Ωt stabiln√≠ 3x za sebou p≈ôed detekc√≠ zmƒõny<br/>Move detection: piece_lifted ‚Üí piece_placed ‚Üí GAME_CMD_PICKUP/DROP p≈ôes game_command_queue

# -----------------------------------------------------------------------------
# H3. Button task detail
# -----------------------------------------------------------------------------
# Detailn√≠ flow button tasku: GPIO scan, debounce, event detection, button
# event queue.

sequenceDiagram
    participant BT as buttonTask
    participant GPIO as GPIO_Hardware
    participant BQ as buttonEventQueue
    participant G as gameTask

    Note over BT: button_task_start() - Hlavn√≠ smyƒçka (5ms cyklus)
    
    loop Ka≈æd√Ω cyklus (5ms)
        BT->>BT: esp_task_wdt_reset_safe() - Watchdog reset
        
        Note over BT: GPIO scan v≈°ech tlaƒç√≠tek
        BT->>GPIO: button_scan_all() - ƒåten√≠ GPIO stav≈Ø
        loop Pro ka≈æd√© tlaƒç√≠tko (0-8)
            BT->>GPIO: gpio_get_level(button_pin) - ƒåten√≠ stavu
            BT->>BT: button_states[button_id] = (pin_level == 0) ? true : false
        end
        
        Note over BT: Detekce zmƒõn a event processing
        BT->>BT: button_process_events() - Detekce zmƒõn stavu
        
        alt Tlaƒç√≠tko stisknuto (button_states[i] != button_previous[i])
            BT->>BT: button_handle_press(button_id)
            BT->>BT: button_press_time[button_id] = current_time
            BT->>BQ: button_send_event(button_id, BUTTON_EVENT_PRESS)
            activate BQ
            G->>BQ: xQueueReceive(button_event_queue)
            G->>G: game_process_promotion_button() / game_reset_game()
            deactivate BQ
        end
        
        alt Tlaƒç√≠tko uvolnƒõno
            BT->>BT: button_handle_release(button_id)
            BT->>BT: Kontrola long press (press_duration >= 1000ms)
            alt Long press detekov√°n
                BT->>BQ: button_send_event(button_id, BUTTON_EVENT_LONG_PRESS)
            end
            BT->>BQ: button_send_event(button_id, BUTTON_EVENT_RELEASE)
            BT->>BT: button_check_double_press(button_id)
            alt Double press detekov√°n (2x stisk do 300ms)
                BT->>BQ: button_send_event(button_id, BUTTON_EVENT_DOUBLE_PRESS)
            end
        end
        
        BT->>BT: vTaskDelay(5ms) - ƒåek√°n√≠ na dal≈°√≠ cyklus
    end
    
    Note over BT: Debouncing: tlaƒç√≠tko mus√≠ b√Ωt stabiln√≠ 50ms p≈ôed detekc√≠ zmƒõny

# -----------------------------------------------------------------------------
# H4. UART task detail
# -----------------------------------------------------------------------------
# Detailn√≠ flow UART tasku: input processing, command parsing, command table,
# response queue.

sequenceDiagram
    participant U as uartTask
    participant HW as UART_Hardware
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant URQ as uartResponseQueue
    participant UM as uartMutex

    Note over U: uart_task_legacy_loop() - Hlavn√≠ smyƒçka (1ms cyklus)
    
    loop Ka≈æd√Ω cyklus (1ms)
        U->>U: esp_task_wdt_reset_safe() - Watchdog reset
        
        Note over U: Input processing
        U->>HW: uart_read_bytes() - ƒåten√≠ znak≈Ø z UART
        alt Znak dostupn√Ω
            U->>U: uart_process_input_char() - Zpracov√°n√≠ znaku
            alt Znak je Enter (\r nebo \n)
                U->>U: command_history_add() - P≈ôid√°n√≠ do historie
                U->>U: uart_parse_command(input_buffer.buffer)
            end
        end
        
        Note over U: Command parsing
        U->>U: uart_parse_command() - Rozdƒõlen√≠ na command a args
        U->>U: find_command(command) - Vyhled√°n√≠ v command table
        alt Command nalezen
            U->>U: execute_command() - Vol√°n√≠ command handleru
            alt Game command (MOVE, UP, DN, etc.)
                U->>U: uart_cmd_move() / uart_cmd_up() / uart_cmd_dn()
                U->>GQ: xQueueSend(GAME_CMD_*) - Posl√°n√≠ p≈ô√≠kazu do game_task
                activate GQ
                G->>GQ: xQueueReceive()
                G->>URQ: xQueueSend(response)
                activate URQ
                U->>URQ: xQueueReceive()
                deactivate URQ
                U->>UM: xSemaphoreTake(uart_mutex)
                U->>HW: uart_write_bytes() - V√Ωpis odpovƒõdi
                U->>UM: xSemaphoreGive(uart_mutex)
                deactivate GQ
            else System command (HELP, STATUS, etc.)
                U->>U: uart_cmd_help() / uart_cmd_status()
                U->>UM: xSemaphoreTake(uart_mutex)
                U->>HW: uart_write_bytes() - V√Ωpis pomoc√≠ uart_mutex
                U->>UM: xSemaphoreGive(uart_mutex)
            end
        else Command nenalezen
            U->>U: uart_send_error("‚ùå Unknown command")
        end
        
        U->>U: vTaskDelay(1ms) - ƒåek√°n√≠ na dal≈°√≠ cyklus
    end

# -----------------------------------------------------------------------------
# H5. Animation task detail
# -----------------------------------------------------------------------------
# Detailn√≠ flow animation tasku: animation command queue, frame execution,
# LED animace.

sequenceDiagram
    participant G as gameTask
    participant AQ as animationCommandQueue
    participant A as animationTask
    participant L as ledTask

    Note over A: animation_task_start() - Hlavn√≠ smyƒçka (50ms cyklus)
    
    loop Ka≈æd√Ω cyklus (50ms)
        A->>A: esp_task_wdt_reset_safe() - Watchdog reset
        
        Note over A: Zpracov√°n√≠ animation commands
        A->>AQ: animation_process_commands() - Zpracov√°n√≠ p≈ô√≠kaz≈Ø z fronty
        loop Pro v≈°echny p≈ô√≠kazy v frontƒõ
            A->>AQ: xQueueReceive(animation_command_queue, 0)
            activate AQ
            alt Command type 0 (Stop all)
                A->>A: animation_stop_all()
            else Command type 1 (Pause all)
                A->>A: animation_pause_all()
            else Command type 2 (Resume all)
                A->>A: animation_resume_all()
            end
            deactivate AQ
        end
        
        Note over A: Frame execution pro aktivn√≠ animace
        loop Pro v≈°echny aktivn√≠ animace
            alt animation.state == ANIM_TASK_STATE_RUNNING
                A->>A: animation_execute_frame() - Generov√°n√≠ frame
                alt ANIM_TASK_TYPE_WAVE
                    A->>A: animation_generate_wave_frame()
                else ANIM_TASK_TYPE_PULSE
                    A->>A: animation_generate_pulse_frame()
                else ANIM_TASK_TYPE_FADE
                    A->>A: animation_generate_fade_frame()
                else ANIM_TASK_TYPE_GAME_OVER
                    A->>A: animation_execute_game_over()
                end
                A->>L: led_set_pixel_safe() - Odesl√°n√≠ frame do LED
                A->>A: anim->current_frame++ - P≈ô√≠prava na dal≈°√≠ frame
                alt anim->current_frame >= anim->total_frames
                    A->>A: animation_stop() - Animace dokonƒçena
                end
            end
        end
        
        A->>A: vTaskDelayUntil(50ms) - ƒåek√°n√≠ na dal≈°√≠ cyklus
    end
    
    Note over G: game_task pos√≠l√° animation commands p≈ôes animation_command_queue

# =============================================================================
# ƒå√ÅST I: WEB SERVER
# =============================================================================

# -----------------------------------------------------------------------------
# I1. Web server flow
# -----------------------------------------------------------------------------
# Kompletn√≠ flow web serveru: HTTP request handling, API endpoints, game
# command queue, JSON responses.

sequenceDiagram
    participant C as WebClient
    participant WS as webServerTask
    participant GQ as gameCommandQueue
    participant G as gameTask
    participant L as ledTask

    Note over C: U≈æivatel klikne na ≈°achovnici - e2 ‚Üí e4
    C->>WS: POST /api/move - {"from":"e2","to":"e4"}
    WS->>WS: http_post_move_handler() - Parsov√°n√≠ JSON
    WS->>WS: web_is_locked() - Kontrola z√°mku
    
    alt Web nen√≠ zamƒçen√Ω
        WS->>WS: chess_move_command_t cmd - GAME_CMD_MAKE_MOVE - from: e2, to: e4
        WS->>GQ: xQueueSend(cmd, 100ms)
        activate GQ
        Note over WS: Non-blocking - Okam≈æit√Ω return
        WS->>C: HTTP 200 OK - {"success":true,"message":"Move queued"}
        G->>GQ: xQueueReceive()
        deactivate GQ
        
        Note over G: game_process_commands() - game_process_chess_move()
        G->>G: game_is_valid_move() - Validace tahu
        
        alt Tah validn√≠
            G->>G: game_execute_move() - Aktualizace board[][]
            G->>L: led_execute_command_new() - Move path animace
            G->>G: game_check_end_game_conditions()
            G->>G: current_player = BLACK
        end
    else Web zamƒçen√Ω
        WS->>C: HTTP 403 Forbidden - {"success":false,"message":"Web locked"}
    end
    
    Note over C: Polling ka≈æd√© 500ms - GET /api/status - GET /api/board
    C->>WS: GET /api/status
    WS->>G: game_get_status_json() - P≈ô√≠m√© vol√°n√≠ API
    G-->>WS: JSON status
    WS->>C: HTTP 200 OK - {"game_state":"active",...}
    
    C->>WS: GET /api/board
    WS->>G: game_get_board_json() - P≈ô√≠m√© vol√°n√≠ API
    G-->>WS: JSON board[8][8]
    WS->>C: HTTP 200 OK - {"board":[[...],...]}

# -----------------------------------------------------------------------------
# I2. Web server API endpoints detail
# -----------------------------------------------------------------------------
# Detail v≈°ech API endpoint≈Ø: GET/POST handlers, JSON parsing, response
# form√°tov√°n√≠.

sequenceDiagram
    participant C as WebClient
    participant WS as webServerTask
    participant G as gameTask
    participant GQ as gameCommandQueue

    Note over WS: HTTP server inicializace - httpd_register_uri_handler()

    alt GET /api/status
        C->>WS: GET /api/status
        WS->>G: game_get_status_json() - P≈ô√≠m√© vol√°n√≠
        G-->>WS: JSON - {"game_state":"active","current_player":"white",...}
        WS->>C: HTTP 200 OK - JSON response
    else GET /api/board
        C->>WS: GET /api/board
        WS->>G: game_get_board_json() - P≈ô√≠m√© vol√°n√≠
        G-->>WS: JSON - {"board":[[...],...]}
        WS->>C: HTTP 200 OK - JSON response
    else POST /api/move
        C->>WS: POST /api/move - {"from":"e2","to":"e4"}
        WS->>WS: http_post_move_handler() - Parsov√°n√≠ JSON
        WS->>WS: web_is_locked() - Kontrola z√°mku
        WS->>GQ: xQueueSend(GAME_CMD_MAKE_MOVE)
        WS->>C: HTTP 200 OK - {"success":true,"message":"Move queued"}
    else POST /api/lock
        C->>WS: POST /api/lock
        WS->>WS: web_lock() - Zamƒçen√≠ web rozhran√≠
        WS->>C: HTTP 200 OK - {"success":true,"locked":true}
    else POST /api/unlock
        C->>WS: POST /api/unlock
        WS->>WS: web_unlock() - Odemƒçen√≠ web rozhran√≠
        WS->>C: HTTP 200 OK - {"success":true,"locked":false}
    else GET / (HTML page)
        C->>WS: GET /
        WS->>C: HTTP 200 OK - HTML ≈°achovnice (embedded)
    end

# =============================================================================
# ƒå√ÅST J: TEST TASK
# =============================================================================

# -----------------------------------------------------------------------------
# J1. Test task main loop
# -----------------------------------------------------------------------------
# Hlavn√≠ smyƒçka test tasku: test execution, reporting, statistics.

sequenceDiagram
    participant TT as testTask
    participant TS as TestSuites

    Note over TT: test_task_start() - Hlavn√≠ smyƒçka

    loop Ka≈æd√Ω cyklus
        TT->>TT: esp_task_wdt_reset_safe() - Watchdog reset
        
        Note over TT: Test execution (pokud je aktivn√≠)
        alt Test aktivn√≠
            TT->>TS: test_run_all_suites() - Spu≈°tƒõn√≠ v≈°ech test sad
            loop Pro ka≈ædou test sadu
                TT->>TS: test_run_suite(suite_id)
                loop Pro ka≈æd√Ω test v sadƒõ
                    TT->>TS: test_execute() - Spu≈°tƒõn√≠ testu
                    TT->>TS: test->result = TEST_RESULT_PASS/FAIL/SKIP
                    TT->>TS: Aktualizace statistik (passed/failed/skipped)
                end
            end
            TT->>TT: test_complete_all_suites() - Dokonƒçen√≠ v≈°ech test≈Ø
            TT->>TT: ESP_LOGI() - V√Ωpis v√Ωsledk≈Ø a statistik
        end
        
        TT->>TT: vTaskDelay() - ƒåek√°n√≠ na dal≈°√≠ cyklus
    end

# -----------------------------------------------------------------------------
# J2. Test execution detail
# -----------------------------------------------------------------------------
# Detailn√≠ flow test execution: hardware tests, system tests, performance
# tests, integration tests.

sequenceDiagram
    participant TT as testTask
    participant TS as TestSuites
    participant HW as Hardware
    participant G as gameTask

    Note over TT: test_run_all_suites() - Spu≈°tƒõn√≠ v≈°ech test≈Ø

    TT->>TS: test_initialize_system() - Inicializace test syst√©mu
    TS->>TS: test_create_suite("Hardware Tests")
    TS->>TS: test_create_suite("System Tests")
    TS->>TS: test_create_suite("Performance Tests")
    TS->>TS: test_create_suite("Integration Tests")

    Note over TT: Hardware Tests Suite
    TT->>TS: test_add_hardware_tests() - LED, Matrix, GPIO, WS2812B, Reed Switch, Power
    loop Pro ka≈æd√Ω hardware test
        TT->>HW: test_execute_led_test() / test_execute_matrix_test() / etc.
        HW-->>TT: TEST_RESULT_PASS/FAIL
        TT->>TS: test->result = result - Aktualizace statistik
    end

    Note over TT: System Tests Suite
    TT->>TS: test_add_system_tests() - FreeRTOS, Queue, Mutex, Timer, Interrupt, Error Handling
    loop Pro ka≈æd√Ω system test
        TT->>G: test_execute_freertos_test() / test_execute_queue_test() / etc.
        G-->>TT: TEST_RESULT_PASS/FAIL
        TT->>TS: test->result = result - Aktualizace statistik
    end

    Note over TT: Performance Tests Suite
    TT->>TS: test_add_performance_tests() - Memory, Task Switching, Queue Performance, LED Performance
    loop Pro ka≈æd√Ω performance test
        TT->>TS: test_execute_performance_test()
        TS-->>TT: TEST_RESULT_PASS/FAIL + metrics
        TT->>TS: test->result = result - Aktualizace statistik
    end

    Note over TT: Integration Tests Suite
    TT->>TS: test_add_integration_tests() - LED-Matrix, Button-LED, Game-Matrix, Full System
    loop Pro ka≈æd√Ω integration test
        TT->>TS: test_execute_integration_test()
        TS-->>TT: TEST_RESULT_PASS/FAIL
        TT->>TS: test->result = result - Aktualizace statistik
    end

    TT->>TS: test_complete_all_suites() - Dokonƒçen√≠ v≈°ech test≈Ø
    TT->>TT: ESP_LOGI() - V√Ωpis kompletn√≠ch v√Ωsledk≈Ø a statistik